
repeat task.wait() until game:IsLoaded()

local Library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Subs = Library.subs
local IsOpen = Subs.Wait

local mainMenuPlaceID = 10450270085
local BossPlaceID = 16379688837
local InvestPlaceID = 16379684339
local placeId = game.PlaceId


local InnateSpinEnabled = false
local slot1Enabled = false
local slot2Enabled = false
local slot3Enabled = false
local huntRare = false 
local huntLegendary = false 
local huntSg = false

local RareInnate = {"Ratio", "Cursed Speech", "Blood Manipulation", "Straw Doll", "Cryokinesis"}
local legendaryInnate = {"Volcano", "Hydrokinesis", "Judgeman", "Puppet", "Projection", "Plant Manipulation"}
local sgInnate = {"Infinity", "Demon Vessel", "Curse Queen", "Soul Manipulation", "Soul King", "Gambler Fever", "Star Rage", "Ancient Construction", "Thunder God"}


local function getFilteredInnate()
    local targetInnate = {}

	 if huntRare then
        for _, innate in ipairs(RareInnate) do
            table.insert(targetInnate, innate)
        end
    end
    if huntLegendary then
        for _, innate in ipairs(legendaryInnate) do
            table.insert(targetInnate, innate)
        end
    end
    if huntSg then
        for _, innate in ipairs(sgInnate) do
            table.insert(targetInnate, innate)
        end
    end
    return targetInnate
end


local function autoSpinInnate()
    task.spawn(function()
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local localPlayer = Players.LocalPlayer


        local spinRemote = ReplicatedStorage:WaitForChild("Remotes")
            :WaitForChild("Server")
            :WaitForChild("Data")
            :WaitForChild("InnateSpin")


        local innates = localPlayer:WaitForChild("ReplicatedData"):WaitForChild("innates")

        while InnateSpinEnabled do
            local targetInnates = getFilteredInnate()


            if slot1Enabled then
                spinRemote:InvokeServer(1)
                local val1 = innates["1"] and innates["1"].Value or ""
                if table.find(targetInnates, val1) then
					print("Slot 1 Innate:", val1)
                    InnateSpinEnabled = false
                    break
                end
            end


            if slot2Enabled then
                if slot1Enabled then task.wait(0.5) end -- Slot 2 quay chậm hơn nếu slot 1 cũng spin
                spinRemote:InvokeServer(2)
                local val2 = innates["2"] and innates["2"].Value or ""
                if table.find(targetInnates, val2) then
				    print("Slot 2 Innate:", val2)
                    InnateSpinEnabled = false
                    break
                end
            end

			if slot3Enabled then
                if slot1Enabled then task.wait(0.5) end
                spinRemote:InvokeServer(2)
                local val3 = innates["3"] and innates["3"].Value or ""
                if table.find(targetInnates, val3) then
				    print("Slot 3 Innate:", val3)
                    InnateSpinEnabled = false
                    break
                end
            end

            task.wait(0.3)
        end
    end)
end


    local Window = Library:CreateWindow({
        Name = "HackerLor",
        Themeable = {
            Info = "VTrungHackerLor",
            Credit = false,
            Background = "",
            Visible = true
        }
    })

	--// Main Tab \\--
	local MainTab = Window:CreateTab({Name = "Main"})
	local MainSection = MainTab:CreateSection({Name = "Farming"})
	local Settings = MainTab:CreateSection({Name = "Settings"})
	local KA = MainTab:CreateSection({Name = "Kill Aura", Side = "Left"})
	local AutoMission = MainTab:CreateSection({Name = "Auto", Side = "Right"})
	local Ect = MainTab:CreateSection({Name = "Ect", Side = "Left"})
	local Calamity = MainTab:CreateSection({Name = "Calamity", Side = "Right"})
	local DailySection = MainTab:CreateSection({Name = "Spin", Side = "Left"})
	local Teleports = MainTab:CreateSection({Name = "Teleports", Side = "Right"})


	--// Misc Tab \\--
	local MiscTab = Window:CreateTab({Name = "Misc"})
	local MiscSection = MiscTab:CreateSection({Name = "Misc"})
	local SpeedAndJump = MiscTab:CreateSection({Name = "Speed&Jump[P]", Side = "Right"})


    -- Toggle Auto Spin
    DailySection:AddToggle({
        Name = "Auto Spin Innate",
        Flag = "AutoSpinInnate",
        Callback = function(state)
            InnateSpinEnabled = state
            if state then autoSpinInnate() end
        end
    })

    -- Toggle slot 1
    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 1",
        Flag = "Slot1",
        State = false,
        Callback = function(state)
            slot1Enabled = state
        end
    })

    -- Toggle slot 2
    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 2",
        Flag = "Slot2",
        State = false,
        Callback = function(state)
            slot2Enabled = state
        end
    })

	    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 3",
        Flag = "Slot3",
        State = false,
        Callback = function(state)
            slot3Enabled = state
        end
    })

    -- Hunt Legendary / SG Innate
    local ClanChooseSection = MainTab:CreateSection({Name = "TròChơiNhânPhẩm", Side = "Right"})

    ClanChooseSection:AddToggle({
        Name = "Săn Rare Innate",
        Flag = "HuntRare",
        Callback = function(state)
            huntRare = state
        end
    })

    ClanChooseSection:AddToggle({
        Name = "Săn Legendary Innate",
        Flag = "HuntLegendary",
        Callback = function(state)
            huntLegendary = state
        end
    })

    ClanChooseSection:AddToggle({
        Name = "Săn Sg Innate",
        Flag = "HuntSg",
        Callback = function(state)
            huntSg = state
        end
    })


local function CastSwitch()
    local inventory = game:GetService("Players").LocalPlayer.ReplicatedData.inventory
    local replicatedStorage = game:GetService("ReplicatedStorage")
    local equipRemote = replicatedStorage:WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Data"):WaitForChild("EquipItem")
    
    local itemsToEquip = {
        "Damage Vial",
        "Damage Gourd",
        "Rage Gourd",
        "Fortune Gourd",
        "Focus Vial",
        "Focus Gourd"
    }
    
    for _, itemName in ipairs(itemsToEquip) do
        if inventory:FindFirstChild(itemName) then
            local args = {itemName}
            equipRemote:InvokeServer(unpack(args))
        end
    end
end


local ToggleBF = false
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local function GetNearestMobInRange(range)
    local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        local hum = mob:FindFirstChild("Humanoid")
        local root = mob.PrimaryPart or mob:FindFirstChild("HumanoidRootPart")

        if hum and hum.Health >= 0 and root then
            if (hrp.Position - root.Position).Magnitude <= range then
                return mob
            end
        end
    end

    return nil
end

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")

getgenv().ToggleBF = false
local cast = false

local function BlackFlashQuick()
	local rs = game:GetService("ReplicatedStorage").Remotes.Server.Combat
	local args = {1.4}
		rs.ApplyBlackFlashToNextHitbox:FireServer(unpack(args))
		rs.M2:FireServer()

end

UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.R then
        BlackFlashQuick()
    end
end)

local function BlackFlashQuickSkillZ()
	local args = {
	2,
	true
}
game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Combat"):WaitForChild("ApplyChantToNextHitbox"):FireServer(unpack(args))

local args = {
	"Demon Vessel: Dismantle"
}
game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Combat"):WaitForChild("Skill"):FireServer(unpack(args))
end


UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.M then
        BlackFlashQuickSkillZ()
    end
end)

local function BlackFlashQuickSkillC()
	local args = {
	2,
	true
}
game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Combat"):WaitForChild("ApplyChantToNextHitbox"):FireServer(unpack(args))

local args = {
	"Demon Vessel: Cleave"
}
game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Combat"):WaitForChild("Skill"):FireServer(unpack(args))
end


UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.N then
        BlackFlashQuickSkillC()
    end
end)

local function BlackFlashQuickSkillV()
	local args = {
	2,
	true
}
game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Combat"):WaitForChild("ApplyChantToNextHitbox"):FireServer(unpack(args))

local args = {
	"Demon Vessel: Flame Arrow"
}
game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Combat"):WaitForChild("Skill"):FireServer(unpack(args))
end


UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.K then
        BlackFlashQuickSkillV()
    end
end)

local function StartBlackFlashLoop()
    if getgenv().ToggleBF then return end
    getgenv().ToggleBF = true

    task.spawn(function()
        while getgenv().ToggleBF do

            local hrp = game.Players.LocalPlayer.Character 
                and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

            local mob = GetNearestMobInRange(100)


            local calamity = workspace.Objects.Mobs:FindFirstChild("Six Eyed Calamity")

            local isCalamityStunned = false
            if calamity
                and calamity:FindFirstChild("Humanoid")
                and calamity.Humanoid:FindFirstChild("CombatAgent")
                and calamity.Humanoid.CombatAgent:FindFirstChild("Statuses")
                and calamity.Humanoid.CombatAgent.Statuses:FindFirstChild("Stunned") then
                isCalamityStunned = true
            end

			if isCalamityStunned and cast == false then
				local args = {
					"Infinity Piercing Vial"
				}
				game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Data"):WaitForChild("EquipItem"):InvokeServer(unpack(args))
				local args = {
					"Binding Chains"
				}
				game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Data"):WaitForChild("EquipItem"):InvokeServer(unpack(args))
                CastSwitch()
				cast = true
			elseif not isCalamityStunned then
				cast = false
			end

            local destructFolder = workspace.Objects:FindFirstChild("Destructibles")
            local hasNonCrystalDestructible = false

            if destructFolder then
                for _, item in ipairs(destructFolder:GetChildren()) do
                    if item.Name ~= "SEC Infinity Crystal" then
                        hasNonCrystalDestructible = true
                    end
                end
            end

            local rs = game:GetService("ReplicatedStorage").Remotes.Server.Combat
            local args = {1.123}

            if isCalamityStunned then
                rs.ApplyBlackFlashToNextHitbox:FireServer(unpack(args))
                rs.M2:FireServer()

            elseif mob or hasNonCrystalDestructible then
                rs.ApplyBlackFlashToNextHitbox:FireServer(unpack(args))
                rs.M2:FireServer()
            end

            task.wait(2)
        end
    end)
end

local function StopBlackFlashLoop()
    getgenv().ToggleBF = false
end



KA:AddToggle({
    Name = "BlackFlash Loop",
    Default = false,
    Callback = function(v)
        if v then
            StartBlackFlashLoop()
        else
            StopBlackFlashLoop()
        end
    end
})



local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local plr = Players.LocalPlayer


local MAX_DISTANCE = 100
local ATTACK_COUNT = 5
local WAIT_AFTER_ATTACK = 1

--// Hàm lấy mob gần nhất trong phạm vi MAX_DISTANCE \\--
local function getClosestMob()
    local mobsFolder = Workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local closestMob = nil
    local closestDistance = math.huge

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        if mob:IsA("Model") then
            local humanoid = mob:FindFirstChild("Humanoid")
            local rootPart = mob:FindFirstChild("HumanoidRootPart")
            if humanoid and humanoid.Health > 0 and rootPart then
                local distance = (rootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                if distance < MAX_DISTANCE and distance < closestDistance then
                    closestDistance = distance
                    closestMob = mob
                end
            end
        end
    end

    return closestMob
end


local function attack(target)
    if not target then return end
    local humanoid = target:FindFirstChild("Humanoid")
    local rootPart = target:FindFirstChild("HumanoidRootPart")
    if not humanoid or humanoid.Health <= 0 or not rootPart then return end

    local playerRoot = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
    if not playerRoot then return end

    local distance = (rootPart.Position - playerRoot.Position).Magnitude
    if distance > MAX_DISTANCE then return end

    local args = {1, {humanoid}}
    ReplicatedStorage
        :WaitForChild("Remotes")
        :WaitForChild("Server")
        :WaitForChild("Combat")
        :WaitForChild("M1")
        :FireServer(unpack(args))
end

--// Kill Aura vòng lặp chính \\--
task.spawn(function()
    local attackCounter = 0
    local currentTarget = nil

    while task.wait(0.2) do
        if getgenv().KillAura and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then


            if not currentTarget 
                or not currentTarget:FindFirstChild("Humanoid") 
                or currentTarget.Humanoid.Health <= 0
                or not currentTarget:FindFirstChild("HumanoidRootPart")
                or (currentTarget.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude > MAX_DISTANCE 
            then
                currentTarget = getClosestMob()
            end

            if currentTarget then

                attack(currentTarget)
                attackCounter = attackCounter + 1

                if attackCounter >= ATTACK_COUNT then
                    attackCounter = 0
                    task.wait(WAIT_AFTER_ATTACK)
                else
                    task.wait(0.1)
                end
            end
        else
            attackCounter = 0
            currentTarget = nil
        end
    end
end)


	--// Kill Aura Toggle \\--
	KA:AddToggle({
		Name = "Kill Aura",
		Flag = "KillAuraToggle",
		Callback = function(v)
			getgenv().KillAura = v
		end
	})


local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")


local function moveToFurthestCharge()
    local player = Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")

    local function getDistance(a, b)
        return (a - b).Magnitude
    end

    local effectsFolder = workspace:WaitForChild("Objects"):WaitForChild("Effects")
    local charges = effectsFolder:GetChildren()
    
    local furthestCharge = nil
    local maxDistance = -math.huge
    
    for _, obj in ipairs(charges) do
        if obj.Name == "SECEnergyCharge" then
            local distance = getDistance(hrp.Position, obj.Position)
            if distance > maxDistance then
                maxDistance = distance
                furthestCharge = obj
            end
        end
    end

    if furthestCharge then
        hrp.CFrame = CFrame.new(furthestCharge.Position + Vector3.new(0, 10, 0))
    end
end


Calamity:AddButton({
    Name = "SECEnergyCharge",
    Callback = moveToFurthestCharge
})


UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.G then
        moveToFurthestCharge()
    end
end)


local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")


local function dodgeCalamity()
    local player = Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")

    local calamity = workspace.Objects.Mobs:FindFirstChild("Six Eyed Calamity")
    if not calamity then return end
    local calamityHRP = calamity:WaitForChild("HumanoidRootPart")

    local offset = hrp.Position - calamityHRP.Position
    local angle = math.rad(-130)

    local rotatedOffset = Vector3.new(
        offset.X * math.cos(angle) - offset.Z * math.sin(angle),
        offset.Y,
        offset.X * math.sin(angle) + offset.Z * math.cos(angle)
    )

    local newPos = calamityHRP.Position + rotatedOffset + Vector3.new(0, 20, 0)

    hrp.CFrame = CFrame.new(newPos)
end

Calamity:AddButton({
    Name = "Né",
    Callback = dodgeCalamity
})


UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Enum.KeyCode.T then
        dodgeCalamity()
    end
end)


local Noclip = nil
local Clip = nil

function noclip()
    Clip = false
    local function Nocl()
        if Clip == false and game.Players.LocalPlayer.Character ~= nil then
            for _,v in pairs(game.Players.LocalPlayer.Character:GetDescendants()) do
                if v:IsA('BasePart') and v.CanCollide and v.Name ~= floatName then
                    v.CanCollide = false
                end
            end
        end
        wait(0.21) 
    end
    Noclip = game:GetService('RunService').Stepped:Connect(Nocl)
end

function clip()
    if Noclip then Noclip:Disconnect() end
    Clip = true
end

Ect:AddToggle({
    Name = "Noclip",
    Default = false,
    Callback = function(value)
        if value then
            noclip()
        else
            clip()
        end
    end
})

	--// NoClip \\--
	local antifallActive = false 
	spawn(function()
		game:GetService("RunService").Stepped:Connect(function()
			if getgenv().Farm or getgenv().MoveAround or getgenv().AutoCollect or getgenv().AutoMoveEnabled then
				for _, v in pairs(game:GetService("Players").LocalPlayer.Character:GetDescendants()) do
					if v:IsA("BasePart") then
						v.CanCollide = false    
					end
					if v:IsA("Humanoid") then
						v:ChangeState(11)
					end
				end
				if not antifallActive then  -- Check if no clip is already active
					antifallActive = true
					EnableAntiFall()
				end
			else
				if antifallActive then
					antifallActive = false
					DisableAntiFall()
				end
			end
		end)
	end)


local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

getgenv().ESPenabled = false
local ESPDistance = true
local ESPTextSize = 18

local function createBillboard(adornee, text, parent)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP"
    billboard.Adornee = adornee
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = parent

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 0, 0)
    label.TextStrokeTransparency = 0
    label.Font = Enum.Font.SourceSansBold
    label.TextScaled = false
    label.TextSize = ESPTextSize
    label.Text = text
    label.Parent = billboard

    return billboard, label
end

local function createESP(player)
    if player == LocalPlayer then return end
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end

    if player.Character:FindFirstChild("ESP") then
        player.Character.ESP:Destroy()
    end

    local root = player.Character:WaitForChild("HumanoidRootPart")
    local billboard, textLabel = createBillboard(root, player.Name, player.Character)

    task.spawn(function()
        while getgenv().ESPenabled 
        and player.Character 
        and player.Character:FindFirstChild("HumanoidRootPart") do

            local distance = (root.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            
            if ESPDistance then
                textLabel.Text = player.Name .. " | " .. math.floor(distance) .. " studs"
            else
                textLabel.Text = player.Name
            end

            task.wait(2)
        end

        if billboard then billboard:Destroy() end
    end)
end

local MobNames = {
    "Egg Jaw",
    "Mantis Curse",
    "Monk of The Lake",
}

local function createMobESP(mob)
    if not mob or not mob:FindFirstChild("HumanoidRootPart") then return end

    if mob:FindFirstChild("ESP") then
        mob.ESP:Destroy()
    end

    local root = mob:WaitForChild("HumanoidRootPart")
    local billboard, textLabel = createBillboard(root, mob.Name, mob)

    task.spawn(function()
        while getgenv().ESPenabled 
        and mob 
        and mob:FindFirstChild("HumanoidRootPart") do

            local distance = (root.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude

            if ESPDistance then
                textLabel.Text = mob.Name .. " | " .. math.floor(distance) .. " studs"
            else
                textLabel.Text = mob.Name
            end

            task.wait(2)
        end

        if billboard then billboard:Destroy() end
    end)
end

local function updateAllMobsESP()
    for _, mobName in ipairs(MobNames) do
        local mobFolder = workspace:FindFirstChild("Objects")
            and workspace.Objects:FindFirstChild("Mobs")

        if mobFolder and mobFolder:FindFirstChild(mobName) then
            local mob = mobFolder[mobName]
            createMobESP(mob)
        end
    end
end

local function updateAllPlayersESP()
    for _, plr in pairs(Players:GetPlayers()) do
        createESP(plr)
    end
end



local function createDropESP(drop)
    if not drop or not (drop:IsA("Model") or drop:IsA("BasePart")) then return end
    
    local name = tostring(drop.Name)
    if name:find("|ChestGroup") or name:find("Talisman") then
        return
    end

    local root = drop:FindFirstChild("HumanoidRootPart") or drop:FindFirstChildWhichIsA("BasePart")
    if not root then return end

    if drop:FindFirstChild("ESP") then
        drop.ESP:Destroy()
    end

    local billboard, textLabel = createBillboard(root, drop.Name, drop)

    task.spawn(function()
        while getgenv().ESPenabled 
        and drop
        and (drop:FindFirstChild("HumanoidRootPart") or drop:FindFirstChildWhichIsA("BasePart")) do

            local pos = root.Position
            local coord = string.format("(%.1f, %.1f, %.1f)", pos.X, pos.Y, pos.Z)

            textLabel.Text = drop.Name .. " | " .. coord

            task.wait(2)
        end

        if billboard then billboard:Destroy() end
    end)
end


local function updateAllDropsESP()
    local dropFolder = workspace:FindFirstChild("Objects")
        and workspace.Objects:FindFirstChild("Drops")

    if dropFolder then
        for _, drop in pairs(dropFolder:GetChildren()) do
            createDropESP(drop)
        end
    end
end



Players.PlayerAdded:Connect(function(player)
    if getgenv().ESPenabled then
        player.CharacterAdded:Wait()
        createESP(player)
    end
end)

Ect:AddToggle({
    Name = "ESP",
    Flag = "ESP_Toggle",
    Callback = function(state)
        getgenv().ESPenabled = state

        if state then
            updateAllPlayersESP()
            updateAllMobsESP()
            updateAllDropsESP()
        else


            for _, plr in pairs(Players:GetPlayers()) do
                if plr.Character and plr.Character:FindFirstChild("ESP") then
                    plr.Character.ESP:Destroy()
                end
            end


            for _, mobName in ipairs(MobNames) do
                local mobFolder = workspace:FindFirstChild("Objects")
                    and workspace.Objects:FindFirstChild("Mobs")

                if mobFolder and mobFolder:FindFirstChild(mobName) then
                    local mob = mobFolder[mobName]
                    if mob:FindFirstChild("ESP") then
                        mob.ESP:Destroy()
                    end
                end
            end


            local dropFolder = workspace:FindFirstChild("Objects")
                and workspace.Objects:FindFirstChild("Drops")

            if dropFolder then
                for _, drop in pairs(dropFolder:GetChildren()) do
                    if drop:FindFirstChild("ESP") then
                        drop.ESP:Destroy()
                    end
                end
            end
        end
    end
})

local LevelValues = {60, 120, 180, 240, 300}

local AutoPromote = false
local PromoteLoop

Ect:AddToggle({
    Name = "Auto Promote Clan Head",
    Default = false,
    Callback = function(state)
        AutoPromote = state

        if AutoPromote then
            PromoteLoop = task.spawn(function()
                while AutoPromote do
                    local level = game:GetService("Players").LocalPlayer.ReplicatedData:FindFirstChild("level")
                    if level then
                        for _, v in ipairs(LevelValues) do
                            if level.Value == v then
                                local args = {
                                    "Clan Head Jujutsu High",
                                    "Promote"
                                }
                                game:GetService("ReplicatedStorage")
                                    :WaitForChild("Remotes")
                                    :WaitForChild("Server")
                                    :WaitForChild("Dialogue")
                                    :WaitForChild("GetResponse")
                                    :InvokeServer(unpack(args))
                                break
                            end
                        end
                    end
                    task.wait(10)
                end
            end)
        else
            if PromoteLoop then
                task.cancel(PromoteLoop)
                PromoteLoop = nil
            end
        end
    end
})

Ect:AddButton({
    Name = "Bypass LVL",
    Callback = function()
        local player = game:GetService("Players").LocalPlayer
        local levelValue = player:WaitForChild("ReplicatedData"):WaitForChild("level")

        levelValue.Value = 480
    end
})


Ect:AddButton({
    Name = "Fly",
    Default = false,
    Callback = function(state)
        getgenv().Fly = state
        if state then
			local main = Instance.new("ScreenGui")
			local Frame = Instance.new("Frame")
			local up = Instance.new("TextButton")
			local down = Instance.new("TextButton")
			local onof = Instance.new("TextButton")
			local TextLabel = Instance.new("TextLabel")
			local plus = Instance.new("TextButton")
			local speed = Instance.new("TextLabel")
			local mine = Instance.new("TextButton")
			local closebutton = Instance.new("TextButton")
			local mini = Instance.new("TextButton")
			local mini2 = Instance.new("TextButton")

			main.Name = "main"
			main.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
			main.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
			main.ResetOnSpawn = false

			Frame.Parent = main
			Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
			Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
			Frame.Position = UDim2.new(0.100320168, 0, 0.379746825, 0)
			Frame.Size = UDim2.new(0, 190, 0, 57)

			up.Name = "up"
			up.Parent = Frame
			up.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
			up.Size = UDim2.new(0, 44, 0, 28)
			up.Font = Enum.Font.SourceSans
			up.Text = "UP"
			up.TextColor3 = Color3.fromRGB(0, 0, 0)
			up.TextSize = 14.000

			down.Name = "down"
			down.Parent = Frame
			down.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
			down.Position = UDim2.new(0, 0, 0.491228074, 0)
			down.Size = UDim2.new(0, 44, 0, 28)
			down.Font = Enum.Font.SourceSans
			down.Text = "DOWN"
			down.TextColor3 = Color3.fromRGB(0, 0, 0)
			down.TextSize = 14.000

			onof.Name = "onof"
			onof.Parent = Frame
			onof.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
			onof.Position = UDim2.new(0.702823281, 0, 0.491228074, 0)
			onof.Size = UDim2.new(0, 56, 0, 28)
			onof.Font = Enum.Font.SourceSans
			onof.Text = "fly"
			onof.TextColor3 = Color3.fromRGB(0, 0, 0)
			onof.TextSize = 14.000

			TextLabel.Parent = Frame
			TextLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
			TextLabel.Position = UDim2.new(0.469327301, 0, 0, 0)
			TextLabel.Size = UDim2.new(0, 100, 0, 28)
			TextLabel.Font = Enum.Font.SourceSans
			TextLabel.Text = "FLY GUI V3"
			TextLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
			TextLabel.TextScaled = true
			TextLabel.TextSize = 14.000
			TextLabel.TextWrapped = true

			plus.Name = "plus"
			plus.Parent = Frame
			plus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
			plus.Position = UDim2.new(0.231578946, 0, 0, 0)
			plus.Size = UDim2.new(0, 45, 0, 28)
			plus.Font = Enum.Font.SourceSans
			plus.Text = "+"
			plus.TextColor3 = Color3.fromRGB(0, 0, 0)
			plus.TextScaled = true
			plus.TextSize = 14.000
			plus.TextWrapped = true

			speed.Name = "speed"
			speed.Parent = Frame
			speed.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
			speed.Position = UDim2.new(0.468421042, 0, 0.491228074, 0)
			speed.Size = UDim2.new(0, 44, 0, 28)
			speed.Font = Enum.Font.SourceSans
			speed.Text = "1"
			speed.TextColor3 = Color3.fromRGB(0, 0, 0)
			speed.TextScaled = true
			speed.TextSize = 14.000
			speed.TextWrapped = true

			mine.Name = "mine"
			mine.Parent = Frame
			mine.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
			mine.Position = UDim2.new(0.231578946, 0, 0.491228074, 0)
			mine.Size = UDim2.new(0, 45, 0, 29)
			mine.Font = Enum.Font.SourceSans
			mine.Text = "-"
			mine.TextColor3 = Color3.fromRGB(0, 0, 0)
			mine.TextScaled = true
			mine.TextSize = 14.000
			mine.TextWrapped = true

			closebutton.Name = "Close"
			closebutton.Parent = main.Frame
			closebutton.BackgroundColor3 = Color3.fromRGB(225, 25, 0)
			closebutton.Font = "SourceSans"
			closebutton.Size = UDim2.new(0, 45, 0, 28)
			closebutton.Text = "X"
			closebutton.TextSize = 30
			closebutton.Position =  UDim2.new(0, 0, -1, 27)

			mini.Name = "minimize"
			mini.Parent = main.Frame
			mini.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
			mini.Font = "SourceSans"
			mini.Size = UDim2.new(0, 45, 0, 28)
			mini.Text = "-"
			mini.TextSize = 40
			mini.Position = UDim2.new(0, 44, -1, 27)

			mini2.Name = "minimize2"
			mini2.Parent = main.Frame
			mini2.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
			mini2.Font = "SourceSans"
			mini2.Size = UDim2.new(0, 45, 0, 28)
			mini2.Text = "+"
			mini2.TextSize = 40
			mini2.Position = UDim2.new(0, 44, -1, 57)
			mini2.Visible = false

			speeds = 1

			local speaker = game:GetService("Players").LocalPlayer

			local chr = game.Players.LocalPlayer.Character
			local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")

			nowe = false

			game:GetService("StarterGui"):SetCore("SendNotification", { 
				Title = "FLY GUI V3";
				Text = "BY XNEO";
				Icon = "rbxthumb://type=Asset&id=5107182114&w=150&h=150"})
			Duration = 5;

			Frame.Active = true
			Frame.Draggable = true

			onof.MouseButton1Down:connect(function()

				if nowe == true then
					nowe = false

					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Flying,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Landed,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Swimming,true)
					speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
				else 
					nowe = true



					for i = 1, speeds do
						spawn(function()

							local hb = game:GetService("RunService").Heartbeat	


							tpwalking = true
							local chr = game.Players.LocalPlayer.Character
							local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
							while tpwalking and hb:Wait() and chr and hum and hum.Parent do
								if hum.MoveDirection.Magnitude > 0 then
									chr:TranslateBy(hum.MoveDirection)
								end
							end

						end)
					end
					game.Players.LocalPlayer.Character.Animate.Disabled = true
					local Char = game.Players.LocalPlayer.Character
					local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")

					for i,v in next, Hum:GetPlayingAnimationTracks() do
						v:AdjustSpeed(0)
					end
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Flying,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Landed,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Swimming,false)
					speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
				end




				if game:GetService("Players").LocalPlayer.Character:FindFirstChildOfClass("Humanoid").RigType == Enum.HumanoidRigType.R6 then



					local plr = game.Players.LocalPlayer
					local torso = plr.Character.Torso
					local flying = true
					local deb = true
					local ctrl = {f = 0, b = 0, l = 0, r = 0}
					local lastctrl = {f = 0, b = 0, l = 0, r = 0}
					local maxspeed = 50
					local speed = 0


					local bg = Instance.new("BodyGyro", torso)
					bg.P = 9e4
					bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
					bg.cframe = torso.CFrame
					local bv = Instance.new("BodyVelocity", torso)
					bv.velocity = Vector3.new(0,0.1,0)
					bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
					if nowe == true then
						plr.Character.Humanoid.PlatformStand = true
					end
					while nowe == true or game:GetService("Players").LocalPlayer.Character.Humanoid.Health == 0 do
						game:GetService("RunService").RenderStepped:Wait()

						if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
							speed = speed+.5+(speed/maxspeed)
							if speed > maxspeed then
								speed = maxspeed
							end
						elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed ~= 0 then
							speed = speed-1
							if speed < 0 then
								speed = 0
							end
						end
						if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (ctrl.f+ctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
							lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
						elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
						else
							bv.velocity = Vector3.new(0,0,0)
						end

						bg.cframe = game.Workspace.CurrentCamera.CoordinateFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed/maxspeed),0,0)
					end
					ctrl = {f = 0, b = 0, l = 0, r = 0}
					lastctrl = {f = 0, b = 0, l = 0, r = 0}
					speed = 0
					bg:Destroy()
					bv:Destroy()
					plr.Character.Humanoid.PlatformStand = false
					game.Players.LocalPlayer.Character.Animate.Disabled = false
					tpwalking = false




				else
					local plr = game.Players.LocalPlayer
					local UpperTorso = plr.Character.UpperTorso
					local flying = true
					local deb = true
					local ctrl = {f = 0, b = 0, l = 0, r = 0}
					local lastctrl = {f = 0, b = 0, l = 0, r = 0}
					local maxspeed = 50
					local speed = 0


					local bg = Instance.new("BodyGyro", UpperTorso)
					bg.P = 9e4
					bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
					bg.cframe = UpperTorso.CFrame
					local bv = Instance.new("BodyVelocity", UpperTorso)
					bv.velocity = Vector3.new(0,0.1,0)
					bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
					if nowe == true then
						plr.Character.Humanoid.PlatformStand = true
					end
					while nowe == true or game:GetService("Players").LocalPlayer.Character.Humanoid.Health == 0 do
						wait()

						if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
							speed = speed+.5+(speed/maxspeed)
							if speed > maxspeed then
								speed = maxspeed
							end
						elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed ~= 0 then
							speed = speed-1
							if speed < 0 then
								speed = 0
							end
						end
						if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (ctrl.f+ctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
							lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
						elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
						else
							bv.velocity = Vector3.new(0,0,0)
						end

						bg.cframe = game.Workspace.CurrentCamera.CoordinateFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed/maxspeed),0,0)
					end
					ctrl = {f = 0, b = 0, l = 0, r = 0}
					lastctrl = {f = 0, b = 0, l = 0, r = 0}
					speed = 0
					bg:Destroy()
					bv:Destroy()
					plr.Character.Humanoid.PlatformStand = false
					game.Players.LocalPlayer.Character.Animate.Disabled = false
					tpwalking = false



				end

			end)

			local tis

			up.MouseButton1Down:connect(function()
				tis = up.MouseEnter:connect(function()
					while tis do
						wait()
						game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0,1,0)
					end
				end)
			end)

			up.MouseLeave:connect(function()
				if tis then
					tis:Disconnect()
					tis = nil
				end
			end)

			local dis

			down.MouseButton1Down:connect(function()
				dis = down.MouseEnter:connect(function()
					while dis do
						wait()
						game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0,-1,0)
					end
				end)
			end)

			down.MouseLeave:connect(function()
				if dis then
					dis:Disconnect()
					dis = nil
				end
			end)


			game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function(char)
				wait(0.7)
				game.Players.LocalPlayer.Character.Humanoid.PlatformStand = false
				game.Players.LocalPlayer.Character.Animate.Disabled = false

			end)


			plus.MouseButton1Down:connect(function()
				speeds = speeds + 1
				speed.Text = speeds
				if nowe == true then


					tpwalking = false
					for i = 1, speeds do
						spawn(function()

							local hb = game:GetService("RunService").Heartbeat	


							tpwalking = true
							local chr = game.Players.LocalPlayer.Character
							local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
							while tpwalking and hb:Wait() and chr and hum and hum.Parent do
								if hum.MoveDirection.Magnitude > 0 then
									chr:TranslateBy(hum.MoveDirection)
								end
							end

						end)
					end
				end
			end)
			mine.MouseButton1Down:connect(function()
				if speeds == 1 then
					speed.Text = 'cannot be less than 1'
					wait(1)
					speed.Text = speeds
				else
					speeds = speeds - 1
					speed.Text = speeds
					if nowe == true then
						tpwalking = false
						for i = 1, speeds do
							spawn(function()

								local hb = game:GetService("RunService").Heartbeat	


								tpwalking = true
								local chr = game.Players.LocalPlayer.Character
								local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
								while tpwalking and hb:Wait() and chr and hum and hum.Parent do
									if hum.MoveDirection.Magnitude > 0 then
										chr:TranslateBy(hum.MoveDirection)
									end
								end

							end)
						end
					end
				end
			end)

			closebutton.MouseButton1Click:Connect(function()
				main:Destroy()
			end)

			mini.MouseButton1Click:Connect(function()
				up.Visible = false
				down.Visible = false
				onof.Visible = false
				plus.Visible = false
				speed.Visible = false
				mine.Visible = false
				mini.Visible = false
				mini2.Visible = true
				main.Frame.BackgroundTransparency = 1
				closebutton.Position =  UDim2.new(0, 0, -1, 57)
			end)

			mini2.MouseButton1Click:Connect(function()
				up.Visible = true
				down.Visible = true
				onof.Visible = true
				plus.Visible = true
				speed.Visible = true
				mine.Visible = true
				mini.Visible = true
				mini2.Visible = false
				main.Frame.BackgroundTransparency = 0 
				closebutton.Position =  UDim2.new(0, 0, -1, 27)
			end)
        end
    end
})



Ect:AddButton({
	Name = "Buff",
	Callback = function()
		CastSwitch()
	end
})


local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")

local HOLD_TIME = 0.05
local TARGET_X = 0.5
local TOLERANCE = 0.05
local isAutoClickEnabled = false
local lastClickedX = nil


local function sendClick()
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
    task.wait(HOLD_TIME)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
end


local function isInTargetRange(x)
    return x >= (TARGET_X - TOLERANCE) and x <= (TARGET_X + TOLERANCE)
end


local function monitorSlider()
    local player = Players.LocalPlayer
    local sliderPath = player.PlayerGui:WaitForChild("Main")
        :WaitForChild("Frame")
        :WaitForChild("BottomMiddle")
        :WaitForChild("QTE")
        :WaitForChild("Timing")
        :WaitForChild("Frame")
        :WaitForChild("Slider")
    
    local previousX = sliderPath.Position.X.Scale
    
    while isAutoClickEnabled do
        local currentX = sliderPath.Position.X.Scale
        
        if currentX ~= previousX then
            if isInTargetRange(currentX) and (lastClickedX == nil or math.abs(currentX - lastClickedX) > 0.01) then
                sendClick()
                lastClickedX = currentX
            end
            
            previousX = currentX
        end
        
        task.wait(0.01)
    end
end


local function RunCalamityBypass()
    isAutoClickEnabled = not isAutoClickEnabled    
    if isAutoClickEnabled then
        lastClickedX = nil
        task.spawn(monitorSlider)
    else
    end
end


Calamity:AddButton({
    Name = "QTE Auto Click",
    Callback = function()
        RunCalamityBypass()
    end
})


local Players = game:GetService("Players")
local player = Players.LocalPlayer
local hrp = nil


local function UpdateHRP(char)
    task.wait(1)
    hrp = char:WaitForChild("HumanoidRootPart")
end

if player.Character then UpdateHRP(player.Character) end
player.CharacterAdded:Connect(UpdateHRP)

local function EnableHover(hrp)
    if not hrp:FindFirstChild("BodyPosition") then
        local bp = Instance.new("BodyPosition")
        bp.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        bp.P = 5e4
        bp.D = 1000
        bp.Name = "BodyPosition"
        bp.Parent = hrp
    end
    if not hrp:FindFirstChild("BodyGyro") then
        local bg = Instance.new("BodyGyro")
        bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
        bg.P = 5e4
        bg.D = 1000
        bg.CFrame = CFrame.new(hrp.Position)
        bg.Name = "BodyGyro"
        bg.Parent = hrp
    end
end

local function DisableHover(hrp)
    local bp = hrp:FindFirstChild("BodyPosition")
    if bp then bp:Destroy() end
    local bg = hrp:FindFirstChild("BodyGyro")
    if bg then bg:Destroy() end
end


local function FollowPlayer(targetPlayer)
    if not hrp or not targetPlayer then return end
    local char = targetPlayer.Character
    if not char then return end
    local targetHRP = char:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end

    EnableHover(hrp)
    local bp = hrp:FindFirstChild("BodyPosition")

    -- cooldown 1 giây
    local lastDrop = 0  

    while getgenv().AutoCalamity and targetPlayer and targetHRP and hrp do
        
        -- FOLLOW TARGET (0.1s)
        if bp then
            bp.Position = targetHRP.Position + Vector3.new(0, -1, 0)
        end

        -- AUTO DROP SHARD (song song - cooldown 1s)
        do
            local now = tick()
            if now - lastDrop >= 1 then
                lastDrop = now

                local chars = workspace:FindFirstChild("Objects")
                    and workspace.Objects:FindFirstChild("Characters")

                if chars then
                    local myChar = chars:FindFirstChild(player.Name)
                    if myChar and myChar:FindFirstChild("Infinity Shard") then
                        -- fire drop shard
                        local args = {"Drop Shard"}
                        game:GetService("ReplicatedStorage")
                            .Remotes.Server.Combat.Skill:FireServer(unpack(args))
                    end
                end
            end
        end

        task.wait(0.1)
    end
end


Calamity:AddButton({
    Name = "Auto Calamity",
    Callback = function()
        getgenv().AutoCalamity = not getgenv().AutoCalamity

        if getgenv().AutoCalamity then

            RunCalamityBypass()
            StartBlackFlashLoop()
			getgenv().KillAura = true
            noclip()

            local targetPlayer = Players:FindFirstChild("anhlongxelan")
            if targetPlayer then
                task.spawn(function()
                    FollowPlayer(targetPlayer)
                end)
            end

        else
			getgenv().KillAura = false
            clip()
            StopBlackFlashLoop()
            if hrp then DisableHover(hrp) end
        end
    end
})


MiscSection:AddToggle({
    Name = "Auto Chest",
    Default = false,
    Callback = function(state)
        getgenv().AutoChest = state

        local Players = game:GetService("Players")
        local player = Players.LocalPlayer
        local StarterGui = game:GetService("StarterGui")
        local workspace = game:GetService("Workspace")


        task.spawn(function()
            while true do
                task.wait(1)
                if not getgenv().AutoChest then continue end

                local dropsFolder = workspace:FindFirstChild("Objects") and workspace.Objects:FindFirstChild("Drops")
                if not dropsFolder then continue end

                for _, drop in ipairs(dropsFolder:GetChildren()) do

                    if not drop.Name:match("^" .. player.Name .. "|") then continue end
                    local chest = drop:FindFirstChild("Chest")
                    if not chest then continue end

                    local prompt = chest:FindFirstChild("Collect")
                    if prompt and prompt:IsA("ProximityPrompt") and prompt.ClickablePrompt and prompt.Enabled then
                        fireproximityprompt(prompt)
                        task.wait(1)

                        local gui = player:WaitForChild("PlayerGui")
                        local lootGUI = gui:FindFirstChild("Loot")
                        if lootGUI then
                            local results = lootGUI:FindFirstChild("Results")
                            if results then
                                local mainFrame = results:FindFirstChild("Main")
                                if mainFrame then
                                    local scrollingFrame = mainFrame:FindFirstChild("ScrollingFrame")
                                    if scrollingFrame then
                                        local frameDetected = false
                                        for _, itemFrame in ipairs(scrollingFrame:GetChildren()) do
                                            if itemFrame.ClassName == "Frame" then
                                                frameDetected = true
                                                break
                                            end
                                        end

                                        if frameDetected then
                                            task.wait(3)
                                            lootGUI:Destroy()
                                            task.wait(1)
                                            local starterLoot = StarterGui:FindFirstChild("Loot")
                                            if starterLoot then
                                                starterLoot:Clone().Parent = gui
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
})




MiscSection:AddButton({
	Name = "No Fog",
	Flag = "NF",
	Keybind = false,
	Callback = function()
		local Lighting = game:GetService("Lighting")
			for _, light in ipairs(Lighting:GetChildren()) do
				if light:IsA("Atmosphere") or string.find(light.Name, "Blur") or string.find(light.Name, "Bloom") then
					light:Destroy()
				end
			Lighting.FogEnd = 1000000
		end
	end
})

AutoMission:AddToggle({
    Name = "InstantKill",
    Default = false,
    Callback = function(state)
        getgenv().InsBoss = state

        if state then
            spawn(function()
                while getgenv().InsBoss do
                    local player = game:GetService("Players").LocalPlayer
                    local char = player.Character
                    local hrp = char and char:FindFirstChild("HumanoidRootPart")

                    local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")

                    for _, mob in ipairs(mobsFolder:GetChildren()) do
                        local humanoid = mob:FindFirstChild("Humanoid")
                        local mobRoot = mob:FindFirstChild("HumanoidRootPart") or mob.PrimaryPart

                        if humanoid and humanoid.Health > 0 and mobRoot then

                            if getgenv().AutoBoss and humanoid.Health <= 2500 then
                                humanoid.Health = 0
                                task.wait(0.1)
                            end

                            if placeId == mainMenuPlaceID then
                                local dist = (mobRoot.Position - hrp.Position).Magnitude
                                if dist <= 700 then
                                    humanoid.Health = 0
                                    task.wait(0.1)
                                end
							else
								if not getgenv().AutoBoss then
								local dist = (mobRoot.Position - hrp.Position).Magnitude
                                if dist <= 700 then
										humanoid.Health = 0
										task.wait(0.1)
								 end
								end
                            end
                        end
                    end

                    task.wait(0.5)
                end
            end)
        end
    end
})


AutoMission:AddToggle({
    Name = "Auto Invest",
    Default = false,
    Callback = function(state)
        getgenv().AutoMissionEnabled = state
        getgenv().FloatingEnabled = state

        local Players = game:GetService("Players")
        local player = Players.LocalPlayer

        getgenv().AutoCollect = false
        getgenv().AutoCivilian = false

        local lastTaskText = nil
        local hrp = nil

        local function UpdateHRP(char)
            task.wait(1)
            hrp = char:WaitForChild("HumanoidRootPart")
        end

        if player.Character then
            UpdateHRP(player.Character)
        end
        player.CharacterAdded:Connect(UpdateHRP)

        local function setFloating(enable)
            if not hrp then return end

            for _, obj in ipairs(hrp:GetChildren()) do
                if obj:IsA("BodyGyro") or obj:IsA("BodyPosition") then
                    obj:Destroy()
                end
            end

            if enable then
                -- Không tạo BodyGyro nữa, chỉ dùng BodyPosition
                local bp = Instance.new("BodyPosition")
                bp.P = 5e4
                bp.D = 1000
                bp.MaxForce = Vector3.new(9e9, 9e9, 9e9)
                bp.Position = hrp.Position
                bp.Parent = hrp
            end
        end

        setFloating(state)

        player.CharacterAdded:Connect(function(char)
            task.wait(1)
            UpdateHRP(char)
            if getgenv().FloatingEnabled then
                setFloating(true)
            end
        end)

        local function MoveToPosition(pos)
            if not hrp then return end
            local bp = hrp:FindFirstChildWhichIsA("BodyPosition")
            if bp then
                bp.Position = pos
            end
        end


        local function FindMobWithQuestMarker()
            local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
            for _, mob in ipairs(mobsFolder:GetChildren()) do
                if mob:IsDescendantOf(workspace) then
                    local questMarker = mob:FindFirstChild("QuestMarker", true)
                    if questMarker then
                        local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                        if mobHRP then
                            return mob, mobHRP
                        end
                        if mob.PrimaryPart then
                            return mob, mob.PrimaryPart
                        end
                    end
                end
            end
            return nil, nil
        end

        task.spawn(function()
            while task.wait(0.01) do

                if not getgenv().AutoMissionEnabled then
                    getgenv().AutoCollect = false
                    getgenv().AutoCivilian = false
                    getgenv().FloatingEnabled = false
                    setFloating(false)
                    continue
                end

                local storylineGui = player:WaitForChild("PlayerGui"):WaitForChild("StorylineDialogue")
                local frame = storylineGui:WaitForChild("Frame")
                local questFrame = frame:WaitForChild("QuestFrame")
                local questInfo = questFrame:WaitForChild("QuestInfo")
                local taskDesc = questInfo:WaitForChild("Task"):WaitForChild("Description")
                local currentTask = taskDesc.Text

                if currentTask ~= lastTaskText then
                    getgenv().AutoCollect = false
                    getgenv().AutoCivilian = false
                    lastTaskText = currentTask
                end

                 if currentTask ~= "Collect all objects" and currentTask ~= "Rescue civilians to the gate" then
                    local targetMob, targetPart = FindMobWithQuestMarker()
                    
                    if targetMob and targetPart then
                        local char = player.Character
                        local hrp = char and char:FindFirstChild("HumanoidRootPart")
                        local humanoid = targetMob:FindFirstChild("Humanoid")
                        if hrp and targetMob:IsDescendantOf(workspace) then
                            local targetPos = targetPart.Position + Vector3.new(0, 8, 0)
                            MoveToPosition(targetPos)
                            
                            hrp.CFrame = CFrame.new(hrp.Position, targetPart.Position)
                            hrp.Velocity = Vector3.zero
                            hrp.AssemblyLinearVelocity = Vector3.zero
                        end
                    end
                end

                if currentTask == "Collect all objects" then
                    if not getgenv().AutoCollect then
                        getgenv().AutoCollect = true
                        task.spawn(function()
                            while getgenv().AutoCollect and task.wait() do
                                local items = workspace:WaitForChild("Objects"):WaitForChild("MissionItems"):GetChildren()
                                if #items == 0 then
                                    getgenv().AutoCollect = false
                                    break
                                end
                                for _, item in ipairs(items) do
                                    if not getgenv().AutoCollect then break end
                                    if not item:IsDescendantOf(workspace) then continue end
                                    if not hrp then continue end
                                    local pivot = item:GetPivot()
                                    MoveToPosition(pivot.Position + Vector3.new(0, 2, 0))
                                    task.wait(0.5)
                                    local prompt = item:FindFirstChild("Collect")
                                    if prompt then fireproximityprompt(prompt) end
                                    task.wait(0.5)
                                end
                            end
                        end)
                    end
                end


                if currentTask == "Rescue civilians to the gate" then
                    if not getgenv().AutoCivilian then
                        getgenv().AutoCivilian = true
                        task.spawn(function()
                            while getgenv().AutoCivilian and task.wait(0.2) do
                                local char = player.Character
                                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                                if not hrp then continue end

                                local civilians = {}
                                for _, obj in ipairs(workspace.Objects.MissionItems:GetChildren()) do
                                    if obj.Name == "Civilian" and obj:IsDescendantOf(workspace) then
                                        table.insert(civilians, obj)
                                    end
                                end

                                if #civilians == 0 then
                                    getgenv().AutoCivilian = false
                                    break
                                end

                                for _, civ in ipairs(civilians) do
                                    if not getgenv().AutoCivilian then break end
                                    if not civ:IsDescendantOf(workspace) then continue end

                                    local ok = pcall(function()
                                        local pivot = civ:GetPivot()
                                        MoveToPosition(pivot.Position + Vector3.new(0, 2, 0))
                                        task.wait(0.5)

                                        local prompt = civ:FindFirstChild("PickUp")
                                        if prompt then
                                            fireproximityprompt(prompt)
                                        end

                                        local t = time()
                                        while civ:FindFirstChild("PickUp") and time() - t < 1 do
                                            task.wait()
                                        end

                                        local spawn = workspace.Map.Parts:FindFirstChild("SpawnLocation")
                                        if spawn then
                                            MoveToPosition(spawn.Position + Vector3.new(0, 3, 0))
                                        end

                                        task.wait(1)
                                    end)

                                    if not ok then
                                        task.wait(0.2)
                                    end
                                end
                            end
                        end)
                    end
                end
				game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Client"):WaitForChild("StorylineDialogueSkip"):FireServer()
            end
        end)
    end
})

getgenv().AutoBoss = false

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

local HoverHeight = 12
local IframeHeight = 20
local OffsetY = 12

local hrp = nil
local function UpdateHRP(char)
    task.wait(1)
    hrp = char:WaitForChild("HumanoidRootPart")
end

if player.Character then
    UpdateHRP(player.Character)
end

player.CharacterAdded:Connect(UpdateHRP)

local function EnableHover(hrp)
    if not hrp:FindFirstChild("BodyPosition") then
        local bp = Instance.new("BodyPosition")
        bp.MaxForce = Vector3.new(9e9,9e9,9e9)
        bp.P = 5e4
        bp.D = 1000
        bp.Name = "BodyPosition"
        bp.Parent = hrp
    end

end

local function DisableHover(hrp)
    local bp = hrp:FindFirstChild("BodyPosition")
    if bp then bp:Destroy() end
    local bg = hrp:FindFirstChild("BodyGyro")
    if bg then bg:Destroy() end
end

local function MoveToBoss()
    if not hrp then return end
    local bossSpawn = workspace:FindFirstChild("Objects")
        and workspace.Objects:FindFirstChild("Spawns")
        and workspace.Objects.Spawns:FindFirstChild("BossSpawn")

    if bossSpawn and bossSpawn:FindFirstChild("QuestMarker") then
        local pivot = bossSpawn:GetPivot()
        if pivot then
		CastSwitch()
		local VirtualInputManager = game:GetService("VirtualInputManager")

            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Three, false, game)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Three, false, game)

            local targetPos = pivot.Position + Vector3.new(0, OffsetY, 0)

            hrp.CFrame = CFrame.new(targetPos, pivot.Position)
            hrp.Velocity = Vector3.zero
            hrp.AssemblyLinearVelocity = Vector3.zero
        end
    end
end

local function HoverOnMob()
    if not hrp then return end
    local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local target, humanoid = nil, nil

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        local h = mob:FindFirstChild("Humanoid")
        if h and h.Health > 0 and mob.PrimaryPart then
            target = mob
            humanoid = h
            break
        end
    end

    -- Không có mob → tắt noclip, dừng hover
    if not target then
        clip()
        DisableHover(hrp)
        return
    end

    -- Có mob → bật noclip
    noclip()
    EnableHover(hrp)

    local bp = hrp:FindFirstChild("BodyPosition")

    while humanoid and humanoid.Health > 0 and target.PrimaryPart and getgenv().AutoBoss do
        local combatAgent = humanoid:FindFirstChild("CombatAgent")
        local iframes = combatAgent and combatAgent:FindFirstChild("Statuses")
            and combatAgent.Statuses:FindFirstChild("Iframes")
        local desiredPos =
            (iframes and iframes.Value)
                and (hrp.Position + Vector3.new(0, IframeHeight, 0))
                or (target.PrimaryPart.Position + Vector3.new(0, HoverHeight, 0))

        if bp then
            bp.Position = desiredPos
        end

        if target.PrimaryPart then
            hrp.CFrame = CFrame.new(hrp.Position, target.PrimaryPart.Position)
            hrp.Velocity = Vector3.zero
            hrp.AssemblyLinearVelocity = Vector3.zero
        end

        task.wait(0.01)
    end

    -- Mob chết hoặc AutoBoss tắt → tắt noclip
    clip()
    DisableHover(hrp)
end

AutoMission:AddToggle({
    Name = "Auto Boss",
    Default = false,
    Callback = function(state)
        getgenv().AutoBoss = state
        if not state then
            clip()
            DisableHover(hrp)
        end
        task.spawn(function()
            while getgenv().AutoBoss do
                if hrp then
                    MoveToBoss()
                    HoverOnMob()
                end
                task.wait(1)
            end
        end)
    end
})



KA:AddToggle({
    Name = "Auto Mob",
    Default = false,
    Callback = function(state)
        getgenv().AutoMob = state
        local HoverHeight = 12
        local Players = game:GetService("Players")
        local workspace = game:GetService("Workspace")
        local player = Players.LocalPlayer
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        
        local function UpdateHRP(char)
            task.wait(0.2)
            hrp = char:WaitForChild("HumanoidRootPart")
        end
        player.CharacterAdded:Connect(UpdateHRP)
        
        local function HoverOnNearestMob()
            if not hrp then return end
            local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
            local target, humanoid = nil, nil
            local closestDistance = math.huge
            
            for _, mob in ipairs(mobsFolder:GetChildren()) do
                local h = mob:FindFirstChild("Humanoid")
                if h and h.Health > 0 and mob.PrimaryPart then
                    local distance = (hrp.Position - mob.PrimaryPart.Position).Magnitude
                    if distance < closestDistance and distance <= 100 then
                        closestDistance = distance
                        target = mob
                        humanoid = h
                    end
                end
            end
            
            if not target then
                DisableHover(hrp)
                return
            end
            
			local VirtualInputManager = game:GetService("VirtualInputManager")
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Three, false, game)
            task.wait(0.05)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Three, false, game)

            EnableHover(hrp)
            local bp = hrp:FindFirstChild("BodyPosition")
            
            while humanoid and humanoid.Health > 0 and target.PrimaryPart and getgenv().AutoMob do
                local distance = (hrp.Position - target.PrimaryPart.Position).Magnitude
                if distance > 100 then break end
                
                local desiredPos = target.PrimaryPart.Position + Vector3.new(0, HoverHeight, 0)
                
                if bp then 
                    bp.Position = desiredPos 
                end
                

                if target.PrimaryPart then
                    local lookAtPos = target.PrimaryPart.Position
                    hrp.CFrame = CFrame.new(hrp.Position, lookAtPos)
                    hrp.Velocity = Vector3.zero
                    hrp.AssemblyLinearVelocity = Vector3.zero
                end
                

                task.wait(0.01)
            end
            DisableHover(hrp)
        end
        
        task.spawn(function()
            while getgenv().AutoMob do
                if hrp then
                    HoverOnNearestMob()
                end
                task.wait(1)
            end
        end)
    end
})

AutoMission:AddToggle({
    Name = "Auto Quest",
    Default = false,
    Callback = function(state)
        getgenv().AutoRerollQuest = state
        
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local TweenService = game:GetService("TweenService")
        local VirtualInputManager = game:GetService("VirtualInputManager")
        local workspace = game:GetService("Workspace")
        local player = Players.LocalPlayer
        local username = player.Name
        
        local currentTween = nil
        local targetPosition = Vector3.new(-505.3, 4470.24, -15619.8)
        local returnCount = 0
        
        local function pressJ()
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.J, false, game)
            task.wait(0.1)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.J, false, game)
        end
        
        local function tweenToPosition(position)
            if not getgenv().AutoRerollQuest then return false end
            
            local character = player.Character
            if not character then return false end
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if not hrp then return false end
            
            local tweenInfo = TweenInfo.new(
                (hrp.Position - position).Magnitude / 100,
                Enum.EasingStyle.Linear
            )
            
            currentTween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(position)})
            currentTween:Play()
            
            local completed = false
            local connection
            connection = currentTween.Completed:Connect(function()
                completed = true
                connection:Disconnect()
            end)
            
            while not completed and getgenv().AutoRerollQuest do
                task.wait(0.1)
            end
            
            if not getgenv().AutoRerollQuest then
                if currentTween then
                    currentTween:Cancel()
                end
                if connection then
                    connection:Disconnect()
                end
                return false
            end
            
            return true
        end
        
        local function getMob()
            local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
            for _, mob in ipairs(mobsFolder:GetChildren()) do
                if mob:IsDescendantOf(workspace) then
                    local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                    if mobHRP then
                        return mob, mobHRP.Position
                    end
                    if mob.PrimaryPart then
                        return mob, mob.PrimaryPart.Position
                    end
                end
            end
            return nil, nil
        end
        
        -- Hàm mới: Kiểm tra khoảng cách đến mob gần nhất
        local function getDistanceToNearestMob()
            local character = player.Character
            if not character then return math.huge end
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if not hrp then return math.huge end
            
            local _, mobPos = getMob()
            if mobPos then
                return (hrp.Position - mobPos).Magnitude
            end
            return math.huge
        end
        
        -- Hàm mới: Gọi J và kiểm tra khoảng cách mob
        local function pressJAndCheckDistance()
            if not getgenv().AutoRerollQuest then return false end
            
            pressJ()
            task.wait(2) -- Đợi teleport hoàn tất
            
            if not getgenv().AutoRerollQuest then return false end
            
            -- Kiểm tra khoảng cách đến mob
            local distance = getDistanceToNearestMob()
            
            -- Nếu mob xa hơn 1000 đơn vị, gọi lại J
            while distance > 1000 and getgenv().AutoRerollQuest do
                pressJ()
                task.wait(2)
                
                if not getgenv().AutoRerollQuest then return false end
                
                distance = getDistanceToNearestMob()
            end
            
            return true
        end
        
        local function waitUntilAllMobsGone()
            local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
            local currentTargetMob = nil
            
            while getgenv().AutoRerollQuest do
                local mobCount = 0
                for _, mob in ipairs(mobsFolder:GetChildren()) do
                    if mob:IsDescendantOf(workspace) then
                        mobCount = mobCount + 1
                    end
                end
                
                if mobCount == 0 then
                    return true
                end
                
                if currentTargetMob and not currentTargetMob:IsDescendantOf(workspace) then
                    currentTargetMob = nil
                end
                
                if not currentTargetMob then
                    local mob, mobPos = getMob()
                    if mob and mobPos then
                        currentTargetMob = mob
                        local success = tweenToPosition(mobPos + Vector3.new(0, 5, 0))
                        if not success then
                            return false
                        end
                    end
                end
                
                task.wait(0.5)
            end
            
            return false
        end
        
        local function checkQuestValid()
            local missionsFolder = ReplicatedStorage:WaitForChild("Missions")
            local userMissions = missionsFolder:FindFirstChild(username)
            if not userMissions then return false, nil end
            
            local shijoSet = userMissions:FindFirstChild("Shijo Town Set")
            if not shijoSet then return false, nil end
            
            for _, questName in ipairs({"Quest1", "Quest2", "Quest3"}) do
                local quest = shijoSet:FindFirstChild(questName)
                if quest then
                    local difficulty = quest:FindFirstChild("difficulty")
                    local title = quest:FindFirstChild("title")
                    
                    if difficulty and difficulty.Value == 3 and title then
                        if title.Value == "Exorcise" or title.Value == "Defeat" then
                            return true, quest
                        end
                    end
                end
            end
            
            return false, nil
        end
        
        local function claimQuest(questObject)
            local args = {questObject}
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Data"):WaitForChild("ClaimQuest"):InvokeServer(unpack(args))
        end
        
        local function isNearTargetPosition(targetPos, maxDistance)
            local character = player.Character
            if not character then return false end
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if not hrp then return false end
            
            return (hrp.Position - targetPos).Magnitude <= maxDistance
        end
        
        local function returnToTargetPosition()
            if not getgenv().AutoRerollQuest then return false end
            
            while not isNearTargetPosition(targetPosition, 1000) and getgenv().AutoRerollQuest do
                pressJ()
                task.wait(2)
            end
            
            if not getgenv().AutoRerollQuest then return false end
            
            local tweenSuccess = tweenToPosition(targetPosition)
            return tweenSuccess
        end
        
        task.spawn(function()
            while getgenv().AutoRerollQuest do
                local isValid, validQuest = checkQuestValid()
                
                while not isValid and getgenv().AutoRerollQuest do
                    local rerollArgs = {"Shijo Town Set"}
                    ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Data"):WaitForChild("RerollMissions"):InvokeServer(unpack(rerollArgs))
                    task.wait(1)
                    isValid, validQuest = checkQuestValid()
                end
                
                if not getgenv().AutoRerollQuest then break end
                
                if validQuest then
                    claimQuest(validQuest)
                    task.wait(0.5)
                    
                    if not getgenv().AutoRerollQuest then break end
                    
                    -- Sử dụng hàm mới với kiểm tra khoảng cách
                    local pressJSuccess = pressJAndCheckDistance()
                    if not pressJSuccess then break end
                    
                    if not getgenv().AutoRerollQuest then break end
                    
                    local allMobsGone = waitUntilAllMobsGone()
                    
                    if not allMobsGone then
                        break 
                    end
                    
                    if not getgenv().AutoRerollQuest then break end
                    
                    local returnSuccess = returnToTargetPosition()
                    
                    if not returnSuccess then
                        break
                    end
                    
                    returnCount = returnCount + 1
                    
                    if returnCount >= 10 then
                        local rerollArgs = {"Shijo Town Set"}
                        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Data"):WaitForChild("RerollMissions"):InvokeServer(unpack(rerollArgs))
                        task.wait(1)
                        returnCount = 0
                    end
                    
                    task.wait(8)
                end
            end
            
            if currentTween then
                currentTween:Cancel()
                currentTween = nil
            end
        end)
    end
})

getgenv().AutoReplay = false
local player = game.Players.LocalPlayer

local function HasDrops()
    local dropsFolder = workspace:FindFirstChild("Objects") and workspace.Objects:FindFirstChild("Drops")
    if not dropsFolder then return false end
    return #dropsFolder:GetChildren() > 0
end

local function GetHealth()
    if not player.Character then return 100 end
    local humanoid = player.Character:FindFirstChildWhichIsA("Humanoid")
    return humanoid and humanoid.Health or 100
end

function StartAutoReplay()
    task.spawn(function()
        while getgenv().AutoReplay do
            local replicatedStorage = game:GetService("ReplicatedStorage")
            local playerGui = player:WaitForChild("PlayerGui")

            local invResults = playerGui:FindFirstChild("InvestigationResults")
            if invResults then invResults:Destroy() end

            local CalaResults = playerGui:FindFirstChild("CalamityResults")
            if CalaResults then CalaResults:Destroy() end

            local readyReplay = replicatedStorage:FindFirstChild("ReadyReplay")
            local dropsExist = HasDrops()
            local health = GetHealth()


            local remote = replicatedStorage
                :WaitForChild("Remotes")
                :WaitForChild("Server")
                :WaitForChild("Misc")
                :WaitForChild("ReadyReplay")

            if readyReplay and readyReplay.Value == 0 then
                task.wait(4)
                local dropsExistAfterDelay = HasDrops()


                if not dropsExistAfterDelay then
                    remote:FireServer()
                end
            end

            if dropsExist and health <= 0 then
                remote:FireServer()
            end

            task.wait(1)
        end
    end)
end

AutoMission:AddToggle({
    Name = "Auto Replay",
    Default = false,
    Callback = function(State)
        getgenv().AutoReplay = State
        if State then
            StartAutoReplay()
        end
    end,
})


if placeId == mainMenuPlaceID then
	local SelectedTown = nil

	local Towns = {}

	local townNames = {"Town1", "Town2", "Town3", "Town4", "Town5"}

	for _, name in ipairs(townNames) do
		local success, townInstance = pcall(function()
			return workspace:WaitForChild("Objects"):WaitForChild("Locations"):WaitForChild("Towns"):WaitForChild(name)
		end)
		if success and townInstance then
			Towns[name] = townInstance
		end
	end

	for townName, townInstance in pairs(Towns) do
		Teleports:AddToggle({
			Name = townName,
			Default = false,
			Callback = function(state)
				if state then
					SelectedTown = townInstance

					for otherName, _ in pairs(Towns) do
						if otherName ~= townName then
							Teleports:UpdateToggle(otherName, false)
						end
					end
				else
					if SelectedTown == townInstance then
						SelectedTown = nil
					end
				end
			end
		})
	end

	Teleports:AddButton({
		Name = "Teleport",
		Callback = function()
			if SelectedTown then
				local player = game:GetService("Players").LocalPlayer
				local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
				if hrp and SelectedTown:IsDescendantOf(workspace) then
					local pivot = SelectedTown:GetPivot()
					local offsetY = 10
					hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, offsetY, 0))
					task.wait(1)
				else
					warn("Town chưa load hoặc không tồn tại trong workspace!")
				end
			else
				warn("Chưa chọn Town để dịch chuyển!")
			end
		end
	})
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local plr = Players.LocalPlayer
local Character = plr.Character or plr.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")

-- Giá trị mặc định
local WalkSpeed = 150
local JumpPower = 100
local isEnabled = false

-- Các connection để có thể disconnect
local walkSpeedConnection
local jumpPowerConnection

-- Hàm cập nhật Humanoid mới khi respawn
local function updateHumanoid(char)
    Character = char
    Humanoid = char:WaitForChild("Humanoid")
    
    -- Disconnect các connection cũ nếu có
    if walkSpeedConnection then walkSpeedConnection:Disconnect() end
    if jumpPowerConnection then jumpPowerConnection:Disconnect() end
    
    -- Áp dụng giá trị nếu đang bật
    if isEnabled then
        Humanoid.WalkSpeed = WalkSpeed
        Humanoid.JumpPower = JumpPower
        
        -- Theo dõi khi WalkSpeed hoặc JumpPower bị reset
        walkSpeedConnection = Humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
            if Humanoid.WalkSpeed ~= WalkSpeed then
                Humanoid.WalkSpeed = WalkSpeed
            end
        end)
        
        jumpPowerConnection = Humanoid:GetPropertyChangedSignal("JumpPower"):Connect(function()
            if Humanoid.JumpPower ~= JumpPower then
                Humanoid.JumpPower = JumpPower
            end
        end)
    end
end

plr.CharacterAdded:Connect(updateHumanoid)
updateHumanoid(Character)

-- Xử lý phím P để bật/tắt
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.P then
        isEnabled = not isEnabled
        
        if Humanoid then
            if isEnabled then
                -- Bật: áp dụng speed và jump tùy chỉnh
                Humanoid.WalkSpeed = WalkSpeed
                Humanoid.JumpPower = JumpPower
                
                -- Theo dõi khi bị reset
                walkSpeedConnection = Humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
                    if Humanoid.WalkSpeed ~= WalkSpeed then
                        Humanoid.WalkSpeed = WalkSpeed
                    end
                end)
                
                jumpPowerConnection = Humanoid:GetPropertyChangedSignal("JumpPower"):Connect(function()
                    if Humanoid.JumpPower ~= JumpPower then
                        Humanoid.JumpPower = JumpPower
                    end
                end)
            else
                -- Tắt: ngắt kết nối, để hệ thống tự áp dụng giá trị mặc định
                if walkSpeedConnection then walkSpeedConnection:Disconnect() end
                if jumpPowerConnection then jumpPowerConnection:Disconnect() end

            end
        end
    end
end)

-- Khi người dùng thay đổi slider
SpeedAndJump:AddSlider({
    Name = "WalkSpeed",
    Value = WalkSpeed,
    Min = 16,
    Max = 300,
    Flag = "WalkSpeed",
    Textbox = true,
    Callback = function(state)
        WalkSpeed = state
        if Humanoid and isEnabled then
            Humanoid.WalkSpeed = WalkSpeed
        end
    end
})

SpeedAndJump:AddSlider({
    Name = "JumpPower",
    Value = JumpPower,
    Min = 50,
    Max = 500,
    Flag = "JumpPower",
    Textbox = true,
    Callback = function(state)
        JumpPower = state
        if Humanoid and isEnabled then
            Humanoid.JumpPower = JumpPower
        end
    end
})


local VirtualUser = game:GetService("VirtualUser")
	local Players = game:GetService("Players")



	local function naturalWaitTime()
		local baseTime = 600
		local offset = math.random(-120, 180)
		return math.max(300, baseTime + offset)
	end

	spawn(function()
		while true do
			wait(naturalWaitTime()) 
			if Players.LocalPlayer and Players.LocalPlayer.Character then
				VirtualUser:CaptureController()
				VirtualUser:ClickButton2(Vector2.new(math.random(100, 1820), math.random(100, 980))) 
			end
		end
	end)
