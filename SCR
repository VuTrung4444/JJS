repeat task.wait() until game:IsLoaded()

local Library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Subs = Library.subs
local IsOpen = Subs.Wait

local mainMenuPlaceID = 10450270085
local BossPlaceID = 16379688837
local InvestPlaceID = 16379684339
local placeId = game.PlaceId


local InnateSpinEnabled = false
local slot1Enabled = false
local slot2Enabled = false
local huntLegendary = false  
local huntSg = false


local legendaryInnate = {"Volcano", "Hydrokinesis", "Judgeman", "Puppet", "Projection", "Plan Manipulation"}
local sgInnate = {"Infinity", "Demon Vessel", "Curse Queen", "Soul Manipulation", "Gamble Fever", "Star Rage", "Ancient Construction", "Thunder God"}


local function getFilteredInnate()
    local targetInnate = {}
    if huntLegendary then
        for _, innate in ipairs(legendaryInnate) do
            table.insert(targetInnate, innate)
        end
    end
    if huntSg then
        for _, innate in ipairs(sgInnate) do
            table.insert(targetInnate, innate)
        end
    end
    return targetInnate
end


local function autoSpinInnate()
    task.spawn(function()
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local localPlayer = Players.LocalPlayer


        local spinRemote = ReplicatedStorage:WaitForChild("Remotes")
            :WaitForChild("Server")
            :WaitForChild("Data")
            :WaitForChild("InnateSpin")


        local innates = localPlayer:WaitForChild("ReplicatedData"):WaitForChild("innates")

        while InnateSpinEnabled do
            local targetInnates = getFilteredInnate()


            if slot1Enabled then
                spinRemote:InvokeServer(1)
                local val1 = innates["1"] and innates["1"].Value or ""
                print("Slot 1 Innate:", val1)
                if table.find(targetInnates, val1) then
                    InnateSpinEnabled = false
                    break
                end
            end


            if slot2Enabled then
                if slot1Enabled then task.wait(0.5) end -- Slot 2 quay chậm hơn nếu slot 1 cũng spin
                spinRemote:InvokeServer(2)
                local val2 = innates["2"] and innates["2"].Value or ""
                print("Slot 2 Innate:", val2)
                if table.find(targetInnates, val2) then
                    InnateSpinEnabled = false
                    break
                end
            end

            task.wait(0.3)
        end
    end)
end


    local Window = Library:CreateWindow({
        Name = "HackerLor",
        Themeable = {
            Info = "VTrungHackerLor",
            Credit = false,
            Background = "",
            Visible = true
        }
    })

	--// Main Tab \\--
	local MainTab = Window:CreateTab({Name = "Main"})
	local MainSection = MainTab:CreateSection({Name = "Farming"})
	local Settings = MainTab:CreateSection({Name = "Settings"})
	local KA = MainTab:CreateSection({Name = "Kill Aura", Side = "Left"})
	local AutoMission = MainTab:CreateSection({Name = "Auto", Side = "Right"})
	local DailySection = MainTab:CreateSection({Name = "Spin", Side = "Left"})
	local Teleports = MainTab:CreateSection({Name = "Teleports", Side = "Right"})
	local AuraTab = MainTab:CreateSection({Name = "AuraSkills", Side = "Left"})


	--// Misc Tab \\--
	local MiscTab = Window:CreateTab({Name = "Misc"})
	local MiscSection = MiscTab:CreateSection({Name = "Misc"})
	local Ect = MiscTab:CreateSection({Name = "Ect", Side = "Left"})
	local Breathings = MiscTab:CreateSection({Name = "Breathings", Side = "Left"})
	local SpeedAndJump = MiscTab:CreateSection({Name = "Speed&Jump", Side = "Right"})



    -- Toggle Auto Spin
    DailySection:AddToggle({
        Name = "Auto Spin Innate",
        Flag = "AutoSpinInnate",
        Callback = function(state)
            InnateSpinEnabled = state
            if state then autoSpinInnate() end
        end
    })

    -- Toggle slot 1
    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 1",
        Flag = "Slot1",
        State = false,
        Callback = function(state)
            slot1Enabled = state
        end
    })

    -- Toggle slot 2
    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 2",
        Flag = "Slot2",
        State = false,
        Callback = function(state)
            slot2Enabled = state
        end
    })

    -- Hunt Legendary / SG Innate
    local ClanChooseSection = MainTab:CreateSection({Name = "TròChơiNhânPhẩm", Side = "Right"})

    ClanChooseSection:AddToggle({
        Name = "Săn Legendary Innate",
        Flag = "HuntLegendary",
        Callback = function(state)
            huntLegendary = state
        end
    })

    ClanChooseSection:AddToggle({
        Name = "Săn Sg Innate",
        Flag = "HuntSg",
        Callback = function(state)
            huntSg = state
        end
    })

local ToggleBF = false
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local function GetNearestMobInRange(range)
    local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        local hum = mob:FindFirstChild("Humanoid")
        local root = mob.PrimaryPart or mob:FindFirstChild("HumanoidRootPart")

        if hum and hum.Health > 0 and root then
            if (hrp.Position - root.Position).Magnitude <= range then
                return mob
            end
        end
    end

    return nil
end

KA:AddToggle({
    Name = "BlackFlash Loop",
    Default = false,
    Callback = function(v)
        ToggleBF = v
        
        if v then
            task.spawn(function()
                while ToggleBF do
                    local mob = GetNearestMobInRange(100)

                    if mob then
                        -- chạy blackflash
                        local args = {1.123}
                        local rs = game:GetService("ReplicatedStorage").Remotes.Server.Combat

                        rs.ApplyBlackFlashToNextHitbox:FireServer(unpack(args))
                        rs.M2:FireServer()
                    end

                    task.wait(0.3)
                end
            end)
        end
    end
})

	--// Kill Aura Toggle \\--
	KA:AddToggle({
		Name = "Kill Aura",
		Flag = "KillAuraToggle",
		Callback = function(v)
			getgenv().KillAura = v
		end
	})


Ect:AddToggle({
    Name = "HopServer",
    Flag = "HopServerToggle",
    Callback = function(state)
        getgenv().HopServerEnabled = state
        if state then
            task.spawn(function()
                while getgenv().HopServerEnabled do
                    -- Hàm hop server
                    local HttpService = game:GetService("HttpService")
                    local TeleportService = game:GetService("TeleportService")
                    local Players = game:GetService("Players")
                    local placeId = game.PlaceId

                    local function getLowPopServer()
                        local url = string.format("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100", placeId)
                        local success, response = pcall(function()
                            return game:HttpGet(url)
                        end)
                        if success and response then
                            local data = HttpService:JSONDecode(response)
                            for _, server in ipairs(data.data) do
                                if server.playing == 1 and server.maxPlayers > 1 then
                                    return server.id
                                end
                            end
                        end
                    end

                    local function hopToLowPopServer()
                        local serverId = getLowPopServer()
                        if serverId then
                            TeleportService:TeleportToPlaceInstance(placeId, serverId, Players.LocalPlayer)
                        end
                    end

                    hopToLowPopServer()

                    task.wait(10)
                end
            end)
        end
    end
})

--// Services \\--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

--// Biến điều khiển ESP \\--
getgenv().ESPenabled = false
local ESPDistance = true -- hiển thị khoảng cách
local ESPTextSize = 18

--// Hàm tạo ESP cho một người chơi \\--
local function createESP(player)
    if player == LocalPlayer then return end
    if player.Character and not player.Character:FindFirstChild("HumanoidRootPart") then return end

    -- Nếu đã có ESP, xóa trước
    if player.Character:FindFirstChild("ESP") then
        player.Character:FindFirstChild("ESP"):Destroy()
    end

    -- Tạo BillboardGui
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP"
    billboard.Adornee = player.Character:WaitForChild("HumanoidRootPart")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = player.Character

    -- TextLabel hiển thị tên + khoảng cách
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
    textLabel.TextStrokeTransparency = 0
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextScaled = false   -- tắt tự co giãn để dùng TextSize
    textLabel.TextSize = ESPTextSize -- áp dụng cỡ chữ
    textLabel.Parent = billboard

    -- Cập nhật thông tin mỗi 2 giây
    task.spawn(function()
        while getgenv().ESPenabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") do
            local distance = (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if ESPDistance then
                textLabel.Text = player.Name .. " | " .. math.floor(distance) .. " studs"
            else
                textLabel.Text = player.Name
            end
            task.wait(2) -- delay 2 giây
        end
        if billboard then billboard:Destroy() end
    end)
end

--// Tạo ESP cho tất cả người chơi hiện tại và người chơi mới \\--
local function enableESP()
    for _, player in pairs(Players:GetPlayers()) do
        createESP(player)
    end

    Players.PlayerAdded:Connect(function(player)
        createESP(player)
    end)
end

--// Toggle ESP \\--
Ect:AddToggle({
    Name = "ESP",
    Flag = "ESP_Toggle",
    Callback = function(state)
        getgenv().ESPenabled = state
        if state then
            enableESP()
        end
    end
})

local Noclip = nil
local Clip = nil

function noclip()
    Clip = false
    local function Nocl()
        if Clip == false and game.Players.LocalPlayer.Character ~= nil then
            for _,v in pairs(game.Players.LocalPlayer.Character:GetDescendants()) do
                if v:IsA('BasePart') and v.CanCollide and v.Name ~= floatName then
                    v.CanCollide = false
                end
            end
        end
        wait(0.21) 
    end
    Noclip = game:GetService('RunService').Stepped:Connect(Nocl)
end

function clip()
    if Noclip then Noclip:Disconnect() end
    Clip = true
end

Ect:AddToggle({
    Name = "Noclip",
    Default = false,
    Callback = function(value)
        if value then
            noclip()
        else
            clip()
        end
    end
})

	--// NoClip \\--
	local antifallActive = false 
	spawn(function()
		game:GetService("RunService").Stepped:Connect(function()
			if getgenv().Farm or getgenv().MoveAround or getgenv().AutoCollect or getgenv().AutoMoveEnabled then
				for _, v in pairs(game:GetService("Players").LocalPlayer.Character:GetDescendants()) do
					if v:IsA("BasePart") then
						v.CanCollide = false    
					end
					if v:IsA("Humanoid") then
						v:ChangeState(11)
					end
				end
				if not antifallActive then  -- Check if no clip is already active
					antifallActive = true
					EnableAntiFall()
				end
			else
				if antifallActive then
					antifallActive = false
					DisableAntiFall()
				end
			end
		end)
	end)

SpeedAndJump:AddSlider({
		Name = "WalkSpeed",
		Value = 280,
		Min = 16,
		Max = 300,
		Flag = "WalkSpeed",
		Textbox = true,
		Callback = function(State)
			WalkSpeed = State
			if game.Players.LocalPlayer.Character then
				local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("Humanoid")
				if humanoid then
					humanoid.WalkSpeed = WalkSpeed
				end
			end
		end
	})

	SpeedAndJump:AddSlider({
		Name = "JumpPower",
		Value = 150,
		Min = 50,
		Max = 1000,
		Flag = "JumpPower",
		Textbox = true,
		Callback = function(State)
			JumpPower = State
			if game.Players.LocalPlayer.Character then
				local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("Humanoid")
				if humanoid then
					humanoid.JumpPower = JumpPower
				end
			end
		end
	})

MiscSection:AddToggle({
    Name = "AutoCollectChest",
    Default = false,
    Callback = function(state)
        getgenv().AutoChestCollect = state

        local Players = game:GetService("Players")
        local player = Players.LocalPlayer
        local StarterGui = game:GetService("StarterGui")

        task.spawn(function()
            while task.wait(0.1) do
                if not getgenv().AutoChestCollect then continue end
                local dropsFolder = workspace:FindFirstChild("Objects") and workspace.Objects:FindFirstChild("Drops")
                if not dropsFolder then continue end

                for _, drop in pairs(dropsFolder:GetChildren()) do
                    local chest = drop:FindFirstChild("Chest")
                    if chest then
                        local prompt = chest:FindFirstChild("Collect")
                        if prompt then
                            fireproximityprompt(prompt)
                            task.wait(8)
                            local existingLoot = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("Loot")

                            if existingLoot then
                                existingLoot:Destroy()
                            end
                            task.wait(1)
                            local starterLoot = StarterGui:FindFirstChild("Loot")
                            if starterLoot then
                                local newLoot = starterLoot:Clone()
                                newLoot.Parent = player.PlayerGui
                            end
                        break
                        end
                    end
                end
            end
        end)
    end
})


MiscSection:AddButton({
	Name = "No Fog",
	Flag = "NF",
	Keybind = false,
	Callback = function()
		local Lighting = game:GetService("Lighting")
			for _, light in ipairs(Lighting:GetChildren()) do
				if light:IsA("Atmosphere") or string.find(light.Name, "Blur") or string.find(light.Name, "Bloom") then
					light:Destroy()
				end
			Lighting.FogEnd = 1000000
		end
	end
})

AutoMission:AddToggle({
    Name = "Auto Invest",
    Default = false,
    Callback = function(state)
        getgenv().AutoMissionEnabled = state

        local Players = game:GetService("Players")
        local player = Players.LocalPlayer
        local StarterGui = game:GetService("StarterGui")
        local workspaceDrops = workspace:WaitForChild("Objects"):WaitForChild("Drops")


        getgenv().AutoKillMobs = false
        getgenv().AutoCollect = false
        getgenv().AutoCivilian = false

        local lastTaskText = nil

        task.spawn(function()
            while task.wait(1) do
                if not getgenv().AutoMissionEnabled then
                    getgenv().AutoKillMobs = false
                    getgenv().AutoCollect = false
                    getgenv().AutoCivilian = false
                    continue
                end

                local storylineGui = player:WaitForChild("PlayerGui"):WaitForChild("StorylineDialogue")
                local frame = storylineGui:WaitForChild("Frame")
                local questFrame = frame:WaitForChild("QuestFrame")
                local questInfo = questFrame:WaitForChild("QuestInfo")
                local taskDesc = questInfo:WaitForChild("Task"):WaitForChild("Description")
                local currentTask = taskDesc.Text


                if currentTask ~= lastTaskText then
                    getgenv().AutoKillMobs = false
                    getgenv().AutoCollect = false
                    getgenv().AutoCivilian = false
                    lastTaskText = currentTask
                end


                if game.PlaceId == InvestPlaceID then
                    getgenv().AutoKillMobs = true
                end


                if getgenv().AutoKillMobs then
                    for _, mob in ipairs(workspace:WaitForChild("Objects"):WaitForChild("Mobs"):GetChildren()) do
                        local humanoid = mob:FindFirstChild("Humanoid")
                        if humanoid and humanoid.Health > 0 then
                            humanoid.Health = 0
							task.wait(0.5)
                        end
                    end
                end


                if currentTask == "Collect all objects" then
                    if not getgenv().AutoCollect then
                        getgenv().AutoCollect = true
                        task.spawn(function()
                            while getgenv().AutoCollect and task.wait() do
                                local items = workspace:WaitForChild("Objects"):WaitForChild("MissionItems"):GetChildren()
                                if #items == 0 then
                                    getgenv().AutoCollect = false
                                    break
                                end
                                for _, item in ipairs(items) do
                                    if not getgenv().AutoCollect then break end
                                    if not item:IsDescendantOf(workspace) then continue end
                                    local char = player.Character
                                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                                    if not hrp then continue end
                                    local pivot = item:GetPivot()
                                    local offsetY = 20
							hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, offsetY, 0))
                                    task.wait(1.5)
                                    local prompt = item:FindFirstChild("Collect")
                                    if prompt then
                                        fireproximityprompt(prompt)
                                    end
                                    task.wait(0.5)
                                end
                            end
                        end)
                    end
                end


                if currentTask == "Rescue civilians to the gate" then
                    if not getgenv().AutoCivilian then
                        getgenv().AutoCivilian = true
                        task.spawn(function()
                            while getgenv().AutoCivilian and task.wait() do
                                local civilians = {}
                                for _, obj in ipairs(workspace:WaitForChild("Objects"):WaitForChild("MissionItems"):GetChildren()) do
                                    if obj.Name == "Civilian" then
                                        table.insert(civilians, obj)
                                    end
                                end

                                if #civilians == 0 then
                                    print("No more Civilian.")
                                    getgenv().AutoCivilian = false
                                    break
                                end

                                for _, civ in ipairs(civilians) do
                                    if not getgenv().AutoCivilian then break end
                                    if not civ:IsDescendantOf(workspace) then continue end
                                    local char = player.Character
                                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                                    if not hrp then continue end
                                    local pivot = civ:GetPivot()
                                    hrp.CFrame = CFrame.new(pivot.Position)
                                    task.wait(0.4)
                                    local pickup = civ:FindFirstChild("PickUp")
                                    if pickup then
                                        fireproximityprompt(pickup)
                                    end
                                    repeat task.wait() until not civ:FindFirstChild("PickUp")
                                    local spawn = workspace:WaitForChild("Map"):WaitForChild("Parts"):FindFirstChild("SpawnLocation")
                                    if spawn then
                                        hrp.CFrame = CFrame.new(spawn.Position)
                                    end
                                    task.wait(0.5)
                                end
                            end
                        end)
                    end
                end


				if currentTask ~= "Collect all objects" and currentTask ~= "Rescue civilians to the gate" then
				local dropsFolder = workspace:WaitForChild("Objects"):WaitForChild("Drops")
				local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
				local replicatedStorage = game:GetService("ReplicatedStorage")
				local playerGui = player:WaitForChild("PlayerGui")

				task.spawn(function()
					if #mobsFolder:GetChildren() == 0 then
						while task.wait(4) do
							local readyReplay = replicatedStorage:FindFirstChild("ReadyReplay")
							if readyReplay and readyReplay.Value == 0 and #dropsFolder:GetChildren() == 0 then
								task.wait(1)
								local invResults = playerGui:FindFirstChild("InvestigationResults")
								if invResults then
									invResults:Destroy()
								end

								local remote = replicatedStorage:WaitForChild("Remotes"):WaitForChild("Server"):WaitForChild("Misc"):WaitForChild("ReadyReplay")
								remote:FireServer()
							end
						end
					end
				end)


					local mobs = workspace:WaitForChild("Objects"):WaitForChild("Mobs"):GetChildren()
					for _, mob in ipairs(mobs) do
						local char = player.Character
						local hrp = char and char:FindFirstChild("HumanoidRootPart")
						if hrp and mob:IsDescendantOf(workspace) then
							local pivot = mob:GetPivot()
							local offsetY = 50
							hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, offsetY, 0))
							task.wait(4)
						end
					end
				end
            end
        end)
    end
})



getgenv().AutoBoss = false

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local HoverHeight = 5
local IframeHeight = 1000
local OffsetY = 20

---------------------------------------------------------------------
-- ALWAYS cập nhật HRP sau mỗi respawn/replay
---------------------------------------------------------------------
local hrp = nil
local function UpdateHRP(char)
	task.wait(0.2)
	hrp = char:WaitForChild("HumanoidRootPart")
end

if player.Character then
	UpdateHRP(player.Character)
end

player.CharacterAdded:Connect(UpdateHRP)

---------------------------------------------------------------------
-- Hover helpers
---------------------------------------------------------------------
local function EnableHover(hrp)
	if not hrp:FindFirstChild("BodyPosition") then
		local bp = Instance.new("BodyPosition")
		bp.MaxForce = Vector3.new(9e9,9e9,9e9)
		bp.P = 5e4
		bp.D = 1000
		bp.Name = "BodyPosition"
		bp.Parent = hrp
	end
	if not hrp:FindFirstChild("BodyGyro") then
		local bg = Instance.new("BodyGyro")
		bg.MaxTorque = Vector3.new(9e9,9e9,9e9)
		bg.P = 5e4
		bg.D = 1000
		bg.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(math.rad(-90),0,0)
		bg.Name = "BodyGyro"
		bg.Parent = hrp
	end
end

local function DisableHover(hrp)
	local bp = hrp:FindFirstChild("BodyPosition")
	if bp then bp:Destroy() end
	local bg = hrp:FindFirstChild("BodyGyro")
	if bg then bg:Destroy() end
end

---------------------------------------------------------------------
-- Move to BossSpawn
---------------------------------------------------------------------
local function MoveToBoss()
	if not hrp then return end

	local bossSpawn = workspace:FindFirstChild("Objects")
		and workspace.Objects:FindFirstChild("Spawns")
		and workspace.Objects.Spawns:FindFirstChild("BossSpawn")

	if bossSpawn and bossSpawn:FindFirstChild("QuestMarker") then
		local pivot = bossSpawn:GetPivot()
		if pivot then
			hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, OffsetY, 0))
		end
	end
end

---------------------------------------------------------------------
-- Auto Chest
---------------------------------------------------------------------
local function AutoChest()
	local objects = workspace:FindFirstChild("Objects")
	if not objects then return end

	local dropsFolder = objects:FindFirstChild("Drops")
	if not dropsFolder then return end

	for _, drop in pairs(dropsFolder:GetChildren()) do
		local chest = drop:FindFirstChild("Chest")
		if chest then
			local prompt = chest:FindFirstChild("Collect")
			if prompt then
				pcall(function()
					fireproximityprompt(prompt)
task.wait(10)
                            local existingLoot = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("Loot")

                            if existingLoot then
                                existingLoot:Destroy()
                            end
                            task.wait(1)
                            local starterLoot = StarterGui:FindFirstChild("Loot")
                            if starterLoot then
                                local newLoot = starterLoot:Clone()
                                newLoot.Parent = player.PlayerGui
                            end
				end)
			end
		end
	end
end

---------------------------------------------------------------------
-- Hover On Mob + Detect Death → AutoChest + Replay
---------------------------------------------------------------------
local function HoverOnMob()
	if not hrp then return end

	local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")

	local target, humanoid = nil, nil
	for _, mob in ipairs(mobsFolder:GetChildren()) do
		local h = mob:FindFirstChild("Humanoid")
		if h and h.Health > 0 and mob.PrimaryPart then
			target = mob
			humanoid = h
			break
		end
	end

	if not target then
		DisableHover(hrp)
		return
	end

	EnableHover(hrp)
	local bp = hrp:FindFirstChild("BodyPosition")
	local bg = hrp:FindFirstChild("BodyGyro")

	while humanoid and humanoid.Health > 0 and target.PrimaryPart and getgenv().AutoBoss do
		local combatAgent = humanoid:FindFirstChild("CombatAgent")
		local iframes = combatAgent and combatAgent:FindFirstChild("Statuses")
			and combatAgent.Statuses:FindFirstChild("Iframes")

		local desiredPos =
			(iframes and iframes.Value)
				and (hrp.Position + Vector3.new(0, IframeHeight, 0))
				or (target.PrimaryPart.Position + Vector3.new(0, HoverHeight, 0))

		if bp then bp.Position = desiredPos end
		if bg then bg.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(math.rad(90),0,0) end

		task.wait(0.12)
	end

	DisableHover(hrp)

	-- Khi mob chết → chờ 1 giây → AutoChest → Replay
	if humanoid and humanoid.Health <= 0 then
		task.wait(5)
		AutoChest()
task.wait(2)
		RunReplay()
	end
end

---------------------------------------------------------------------
-- Replay
---------------------------------------------------------------------
function RunReplay()
	local readyReplay = ReplicatedStorage:FindFirstChild("ReadyReplay")
	if readyReplay and readyReplay.Value == 0 then

		local playerGui = player:WaitForChild("PlayerGui")
		local invResults = playerGui:FindFirstChild("InvestigationResults")
		if invResults then
			invResults:Destroy()
		end

		local remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Server")
			:WaitForChild("Misc"):WaitForChild("ReadyReplay")
		remote:FireServer()
	end
end

---------------------------------------------------------------------
-- Auto Boss Toggle
---------------------------------------------------------------------
AutoMission:AddToggle({
	Name = "Auto Boss",
	Default = false,
	Callback = function(state)
		getgenv().AutoBoss = state

		task.spawn(function()
			while getgenv().AutoBoss do
				if hrp then
					MoveToBoss()
					HoverOnMob()
				end

				task.wait(2)
			end
		end)
	end
})



local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local plr = Players.LocalPlayer

--// Cấu hình \\--
local MAX_DISTANCE = 100
local ATTACK_COUNT = 5
local WAIT_AFTER_ATTACK = 2

--// Hàm lấy mob gần nhất trong phạm vi MAX_DISTANCE \\--
local function getClosestMob()
    local mobsFolder = Workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local closestMob = nil
    local closestDistance = math.huge

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        if mob:IsA("Model") then
            local humanoid = mob:FindFirstChild("Humanoid")
            local rootPart = mob:FindFirstChild("HumanoidRootPart")
            if humanoid and humanoid.Health > 0 and rootPart then
                local distance = (rootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                if distance < MAX_DISTANCE and distance < closestDistance then
                    closestDistance = distance
                    closestMob = mob
                end
            end
        end
    end

    return closestMob
end

--// Hàm gửi lệnh tấn công đến server \\--
local function attack(target)
    if not target then return end
    local humanoid = target:FindFirstChild("Humanoid")
    local rootPart = target:FindFirstChild("HumanoidRootPart")
    if not humanoid or humanoid.Health <= 0 or not rootPart then return end

    local playerRoot = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
    if not playerRoot then return end

    local distance = (rootPart.Position - playerRoot.Position).Magnitude
    if distance > MAX_DISTANCE then return end

    local args = {1, {humanoid}}
    ReplicatedStorage
        :WaitForChild("Remotes")
        :WaitForChild("Server")
        :WaitForChild("Combat")
        :WaitForChild("M1")
        :FireServer(unpack(args))
end

--// Kill Aura vòng lặp chính \\--
task.spawn(function()
    local attackCounter = 0
    local currentTarget = nil

    while task.wait(0.2) do
        if getgenv().KillAura and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then


            if not currentTarget 
                or not currentTarget:FindFirstChild("Humanoid") 
                or currentTarget.Humanoid.Health <= 0
                or not currentTarget:FindFirstChild("HumanoidRootPart")
                or (currentTarget.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude > MAX_DISTANCE 
            then
                currentTarget = getClosestMob()
            end

            if currentTarget then

                attack(currentTarget)
                attackCounter = attackCounter + 1

                if attackCounter >= ATTACK_COUNT then
                    attackCounter = 0
                    task.wait(WAIT_AFTER_ATTACK)
                else
                    task.wait(0.1) -- delay giữa các lần tấn công
                end
            end
        else
            attackCounter = 0
            currentTarget = nil
        end
    end
end)




	--// Variables \\--
	local plr = game:GetService("Players").LocalPlayer

	local function updateCharacterReferences(character)
		local hrp = character:WaitForChild("HumanoidRootPart")
			_G.Character = character
			_G.HumanoidRootPart = hrp
	end
		if plr.Character then
			updateCharacterReferences(plr.Character)
		end
		plr.CharacterAdded:Connect(function(character)
		updateCharacterReferences(character)
	end)

	local insert = table.insert 
	local character = plr.Character
	local PlrHumanoidRootPart = character:WaitForChild("HumanoidRootPart")

	local plr = game.Players.LocalPlayer
	local Character = plr.Character or plr.CharacterAdded:Wait()	
	local Humanoid = Character and Character:WaitForChild("Humanoid")
	local WalkSpeed = 150
	local JumpPower = 150

	plr.CharacterAdded:Connect(function(Char)
		Character = Char
		Humanoid = Character:WaitForChild("Humanoid")

		-- Cập nhật tốc độ và sức bật ngay khi nhân vật xuất hiện
		if WalkSpeed then
			Humanoid.WalkSpeed = WalkSpeed
		end
		if JumpPower then
			Humanoid.JumpPower = JumpPower
		end
	end)

	game:GetService("RunService").Stepped:Connect(function()
		if Character and Humanoid then
			-- Giữ tốc độ chạy cố định
			if Humanoid.WalkSpeed ~= WalkSpeed then
				Humanoid.WalkSpeed = WalkSpeed
			end
			
			-- Giữ sức bật cố định
			if Humanoid.JumpPower ~= JumpPower then
				Humanoid.JumpPower = JumpPower
			end
		end
	end)

	plr.CharacterAdded:Connect(function(Char)
		Character = Char
		Humanoid = Character:WaitForChild("Humanoid")

		-- Đặt lại tốc độ ngay lập tức
		task.wait(0.1) -- Chờ game cập nhật xong
		Humanoid.WalkSpeed = WalkSpeed
		Humanoid.JumpPower = JumpPower
	end)


	local RunService = game:GetService("RunService");
	local Players = game:GetService("Players");
	local Player = Players.LocalPlayer;
	local chr = Player.Character
	local root = chr and chr:FindFirstChild("HumanoidRootPart")
	local NextFrame = RunService.Heartbeat;


	local VirtualUser = game:GetService("VirtualUser")
	local Players = game:GetService("Players")
	local player = Players.LocalPlayer
	local ReplicatedStorage = game:GetService("ReplicatedStorage")
	local Remotes = ReplicatedStorage:WaitForChild("Remotes")
	local Map = Workspace:WaitForChild("Map")


	local activeToggle = nil
	local toggles = {}





	--// Tween \\--
	local function GetDistance(Endpoint)
		if typeof(Endpoint) == "Instance" then
			Endpoint = Vector3.new(Endpoint.Position.X, game.Players.LocalPlayer.Character.HumanoidRootPart.Position.Y, Endpoint.Position.Z)
		elseif typeof(Endpoint) == "CFrame" then
			Endpoint = Vector3.new(Endpoint.Position.X, game.Players.LocalPlayer.Character.HumanoidRootPart.Position.Y, Endpoint.Position.Z)
		end
		local Magnitude = (Endpoint - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
		return Magnitude
	end

	function Tween(Endpoint)
	if typeof(Endpoint) == "Instance" then
			Endpoint = Endpoint.CFrame
		end
		local TweenFunc = {}
		local Distance = GetDistance(Endpoint)
		local TweenInfo = TweenInfo.new(Distance / getgenv().tweenspeed, Enum.EasingStyle.Linear)

		local targetCFrame = Endpoint

		-- Giữ nguyên hướng nhìn khi ở chế độ "Above" hoặc "Below"
		if FarmMethod == "Above" then
			targetCFrame = CFrame.new(Endpoint.Position) * CFrame.Angles(math.rad(-90), 0, 0)
		elseif FarmMethod == "Below" then
			targetCFrame = CFrame.new(Endpoint.Position) * CFrame.Angles(math.rad(90), 0, 0)
		end

		local TweenObj = game:GetService("TweenService"):Create(
			game.Players.LocalPlayer.Character.HumanoidRootPart, 
			TweenInfo, 
			{ CFrame = targetCFrame }
		)
		TweenObj:Play()

		function TweenFunc:Cancel()
			TweenObj:Cancel()
			return false
		end

		if Distance <= 100 then
			game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = targetCFrame
			TweenObj:Cancel()
			return false
		end

		return TweenFunc
	end

	local function EnableAntiFall()
		local plr = game.Players.LocalPlayer
		if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
			return
		end

		local humanoidRootPart = plr.Character.HumanoidRootPart
		if not humanoidRootPart:FindFirstChild("BodyVelocity") then
			local antifall = Instance.new("BodyVelocity")
			antifall.Velocity = Vector3.new(0, 0, 0)
			antifall.MaxForce = Vector3.new(9e9, 9e9, 9e9)
			antifall.Name = "BodyVelocity"
			antifall.Parent = humanoidRootPart
		end
	end

	local function DisableAntiFall()
		local plr = game.Players.LocalPlayer
		if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
			return
		end

		local humanoidRootPart = plr.Character.HumanoidRootPart
		local humanoid = plr.Character:FindFirstChildOfClass("Humanoid")
		local antifall = humanoidRootPart:FindFirstChild("BodyVelocity")

		-- Xóa lực AntiFall nếu tồn tại
		if antifall then
			antifall:Destroy()
			task.wait(0.1)
		end

		-- Đặt lại vận tốc để tránh bị giữ lại bởi lực cũ
		humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
		humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)

		-- Đảm bảo nhân vật có thể di chuyển
		if humanoid then
			humanoid.PlatformStand = false  -- Ngăn trạng thái đứng yên cứng
			humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)  -- Đưa nhân vật về trạng thái bình thường
			task.wait(0.1)  -- Chờ một chút để trạng thái được cập nhật

			-- Nhảy ngay lập tức để kiểm tra xem có bị khóa không
			humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
		end
	end


	--// Get Closest \\---
	function IsEntitySelected(entity, selectedEntities)
		for _, selectedEntity in ipairs(selectedEntities) do
			if entity.Name == selectedEntity then
				return true
			end
		end
		return false
	end



	function getclosest(selectedEntities, parentFolder)
		local closestEntity = nil
		local closestDistance = math.huge

		local entities = parentFolder:GetDescendants()

		for i, entity in ipairs(entities) do
			if entity:IsA("Model") and IsEntitySelected(entity, selectedEntities) then
				local entityName = entity.Name
				local humanoid = entity:FindFirstChild("Humanoid")
				if humanoid and humanoid.Health > 0 then
					local entityCFrame = entity:GetModelCFrame()
					local distance = (entityCFrame.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
					if distance < closestDistance then
						closestDistance = distance
						closestEntity = entity
					end
				end
			end
		end

		return closestEntity
	end


	local VirtualUser = game:GetService("VirtualUser")
	local Players = game:GetService("Players")

	-- Hàm tạo thời gian random kiểu tự nhiên, có lúc nhanh lúc chậm
	local function naturalWaitTime()
		local baseTime = 600 -- 10 phút
		local offset = math.random(-120, 180) -- lệch ngẫu nhiên từ -2 phút đến +3 phút
		return math.max(300, baseTime + offset) -- đảm bảo tối thiểu 5 phút
	end

	spawn(function()
		while true do
			wait(naturalWaitTime()) 
			if Players.LocalPlayer and Players.LocalPlayer.Character then
				VirtualUser:CaptureController()
				VirtualUser:ClickButton2(Vector2.new(math.random(100, 1820), math.random(100, 980))) 
			end
		end
	end)
